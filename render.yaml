# Render Blueprint - Singapore Property Analytics
# https://render.com/docs/blueprint-spec

services:
  # Main API server
  - type: web
    name: sg-property-analyzer
    env: python
    region: singapore
    plan: starter
    buildCommand: pip install -r backend/requirements.txt
    # Run migrations ONCE per deploy, before starting web server
    # Tracks applied migrations in _migrations table (idempotent)
    releaseCommand: cd backend && python -m scripts.run_migrations
    # Gunicorn flags for 512MB Starter plan:
    # --workers 1    : Single worker fits memory budget
    # --threads 2    : Light concurrency without memory bloat
    # --timeout 90   : Under Render's ~100s router timeout to avoid 504s
    startCommand: cd backend && gunicorn app:app --bind 0.0.0.0:$PORT --workers 1 --threads 2 --timeout 90
    healthCheckPath: /api/health
    envVars:
      - key: PYTHON_VERSION
        value: "3.11.7"
      - key: FLASK_ENV
        value: production
      - key: DATABASE_URL
        sync: false  # Set manually in Render dashboard (Supabase connection string)
      - key: URA_ACCESS_KEY
        sync: false  # Set manually in Render dashboard

# Cron Jobs
# Note: Render cron jobs run as separate instances with their own env
# See: https://render.com/docs/cronjobs

  # URA API Sync - Daily property transaction sync
  - type: cron
    name: ura-sync
    env: python
    region: singapore
    plan: starter
    schedule: "0 17 * * *"  # 01:00 SGT daily (UTC+8)
    buildCommand: pip install -r backend/requirements.txt
    startCommand: cd backend && python -m scripts.ura_sync --triggered-by cron
    envVars:
      - key: PYTHON_VERSION
        value: "3.11.7"
      - key: DATABASE_URL
        sync: false  # Set manually in Render dashboard (Supabase connection string)
      - key: URA_ACCESS_KEY
        sync: false  # Set manually in Render dashboard
      # URA Sync Configuration
      - key: URA_SYNC_ENABLED
        value: "true"
      - key: URA_SYNC_MODE
        value: "shadow"  # Start in shadow mode for 3-7 days
      - key: URA_REVISION_WINDOW_MONTHS
        value: "3"
      - key: URA_CUTOFF_YEARS
        value: "5"

# Database - Using Supabase (external)
# The Render database section below is commented out since we use Supabase.
# DATABASE_URL must be set manually in Render dashboard for both web and cron services.
#
# databases:
#   - name: sgproperty-db
#     plan: starter
#     region: singapore
