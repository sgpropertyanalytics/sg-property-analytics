<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Singapore Condo Resale Dashboard</title>
  <!-- React and ReactDOM - using multiple CDN sources for reliability -->
  <script>
    // Load React with multiple fallback CDNs
    (function loadReact() {
      var reactCDNs = [
        'https://cdn.jsdelivr.net/npm/react@17/umd/react.production.min.js',
        'https://unpkg.com/react@17/umd/react.production.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js'
      ];
      var reactDomCDNs = [
        'https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.production.min.js',
        'https://unpkg.com/react-dom@17/umd/react-dom.production.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js'
      ];
      
      function loadScript(src, onSuccess, onError, retries) {
        retries = retries || 0;
        var script = document.createElement('script');
        script.crossOrigin = 'anonymous';
        script.onload = function() {
          onSuccess();
        };
        script.onerror = function() {
          if (retries < 2) {
            setTimeout(function() {
              loadScript(src, onSuccess, onError, retries + 1);
            }, 1000);
          } else {
            onError();
          }
        };
        script.src = src;
        document.head.appendChild(script);
      }
      
      var reactLoaded = false;
      var reactDomLoaded = false;
      
      function tryLoadReact(index) {
        if (index >= reactCDNs.length) {
          console.error('All React CDNs failed');
          return;
        }
        loadScript(reactCDNs[index], 
          function() {
            if (!reactLoaded && typeof React !== 'undefined') {
              reactLoaded = true;
              console.log('✓ React loaded from:', reactCDNs[index]);
            }
          },
          function() {
            tryLoadReact(index + 1);
          }
        );
      }
      
      function tryLoadReactDOM(index) {
        if (index >= reactDomCDNs.length) {
          console.error('All ReactDOM CDNs failed');
          return;
        }
        loadScript(reactDomCDNs[index],
          function() {
            if (!reactDomLoaded && typeof ReactDOM !== 'undefined') {
              reactDomLoaded = true;
              console.log('✓ ReactDOM loaded from:', reactDomCDNs[index]);
            }
          },
          function() {
            tryLoadReactDOM(index + 1);
          }
        );
      }
      
      tryLoadReact(0);
      tryLoadReactDOM(0);
    })();
  </script>
  
  <!-- Babel Standalone with multiple fallbacks -->
  <script>
    (function loadBabel() {
      var babelCDNs = [
        'https://cdn.jsdelivr.net/npm/@babel/standalone@7/babel.min.js',
        'https://unpkg.com/@babel/standalone@7/babel.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js'
      ];
      
      function loadScript(src, onSuccess, onError, retries) {
        retries = retries || 0;
        var script = document.createElement('script');
        script.onload = function() {
          if (typeof Babel !== 'undefined') {
            onSuccess();
          } else {
            if (retries < 2) {
              setTimeout(function() {
                loadScript(src, onSuccess, onError, retries + 1);
              }, 1000);
            } else {
              onError();
            }
          }
        };
        script.onerror = function() {
          if (retries < 2) {
            setTimeout(function() {
              loadScript(src, onSuccess, onError, retries + 1);
            }, 1000);
          } else {
            onError();
          }
        };
        script.src = src;
        document.head.appendChild(script);
      }
      
      var babelLoaded = false;
      
      function tryLoadBabel(index) {
        if (index >= babelCDNs.length) {
          console.error('All Babel CDNs failed. The dashboard may not work correctly.');
          return;
        }
        loadScript(babelCDNs[index], 
          function() {
            if (!babelLoaded && typeof Babel !== 'undefined') {
              babelLoaded = true;
              console.log('✓ Babel loaded from:', babelCDNs[index]);
              window.babelReady = true;
            }
          },
          function() {
            tryLoadBabel(index + 1);
          }
        );
      }
      
      tryLoadBabel(0);
    })();
  </script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js" onerror="console.warn('Chart.js CDN failed, trying fallback...'); this.src='https://unpkg.com/chart.js@3.9.1/dist/chart.min.js';"></script>
  <script>
    // Wait for all dependencies to be available with better error handling
    (function checkDependencies() {
      var attempts = 0;
      var maxAttempts = 200; // 20 seconds max wait (increased for multiple CDN fallbacks)
      
      function check() {
        attempts++;
        var reactLoaded = typeof React !== 'undefined';
        var reactDomLoaded = typeof ReactDOM !== 'undefined';
        var chartLoaded = typeof Chart !== 'undefined';
        var babelLoaded = typeof Babel !== 'undefined';
        
        if (reactLoaded && reactDomLoaded && chartLoaded && babelLoaded) {
          window.chartJSReady = true;
          window.reactReady = true;
          window.babelReady = true;
          console.log('✓ All dependencies loaded successfully');
          if (window.initDashboard) {
            window.initDashboard();
          }
        } else {
          if (attempts < maxAttempts) {
            setTimeout(check, 100);
          } else {
            console.error('Failed to load dependencies after', attempts, 'attempts:', {
              React: reactLoaded,
              ReactDOM: reactDomLoaded,
              Chart: chartLoaded,
              Babel: babelLoaded
            });
            const root = document.getElementById('root');
            if (root) {
              root.innerHTML = '<div style="padding: 40px; text-align: center; max-width: 600px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"><h2 style="color: #DC2626; margin-bottom: 16px;">⚠️ Library Loading Error</h2><p style="color: #6B7280; margin-bottom: 16px;">Failed to load required libraries. Please:</p><ul style="text-align: left; color: #6B7280; margin: 0 auto; display: inline-block;"><li>Check your internet connection</li><li>Try refreshing the page</li><li>Check browser console for details</li></ul><p style="color: #6B7280; margin-top: 16px; font-size: 12px;">Status: React=' + reactLoaded + ', ReactDOM=' + reactDomLoaded + ', Chart=' + chartLoaded + ', Babel=' + babelLoaded + '</p></div>';
            }
          }
        }
      }
      
      // Start checking after a longer delay to allow multiple CDN attempts
      setTimeout(check, 500);
    })();
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #F3F4F6;
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    window.initDashboard = function() {
      // Check for React and ReactDOM
      if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
        const root = document.getElementById('root');
        if (root) {
          root.innerHTML = '<div style="padding: 40px; text-align: center; max-width: 600px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"><h2 style="color: #DC2626; margin-bottom: 16px;">⚠️ React Library Error</h2><p style="color: #6B7280;">React or ReactDOM library failed to load. Please refresh the page.</p></div>';
        }
        return;
      }
      
      const { useState, useEffect, useRef, useMemo } = React;
      
      if (typeof Chart === 'undefined') {
        const root = document.getElementById('root');
        if (root) {
          root.innerHTML = '<div style="padding: 40px; text-align: center; max-width: 600px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"><h2 style="color: #DC2626; margin-bottom: 16px;">⚠️ Chart Library Error</h2><p style="color: #6B7280;">Chart.js library failed to load. Please refresh the page.</p></div>';
        }
        return;
      }

    const API_BASE = 'http://localhost:5000/api';

    const COLORS = {
      '2b': '#3B82F6',
      '3b': '#10B981',
      '4b': '#F59E0B',
      'young': '#111827'
    };

    const BEDROOM_LABELS = {
      '2b': '2-Bedroom',
      '3b': '3-Bedroom',
      '4b': '4-Bedroom',
    };

    // District names mapping (all 28 districts)
    const DISTRICT_NAMES = {
      'D01': 'Boat Quay / Raffles Place / Marina Downtown / Suntec City',
      'D02': 'Shenton Way / Tanjong Pagar',
      'D03': 'Queenstown / Alexandra / Tiong Bahru',
      'D04': 'Harbourfront / Keppel / Telok Blangah',
      'D05': 'Buona Vista / Dover / Pasir Panjang',
      'D06': 'City Hall / Fort Canning',
      'D07': 'Bugis / Rochor',
      'D08': 'Little India / Farrer Park',
      'D09': 'Orchard / Somerset / River Valley',
      'D10': 'Tanglin / Bukit Timah / Holland',
      'D11': 'Newton / Novena / Dunearn / Watten',
      'D12': 'Balestier / Whampoa / Toa Payoh / Boon Keng / Bendemeer / Kampong Bugis',
      'D13': 'Potong Pasir / Bidadari / MacPherson / Upper Aljunied',
      'D14': 'Geylang / Dakota / Paya Lebar Central / Eunos / Ubi / Aljunied',
      'D15': 'Tanjong Rhu / Amber / Meyer / Katong / Dunman / Joo Chiat / Marine Parade',
      'D16': 'Bedok / Upper East Coast / Eastwood / Kew Drive',
      'D17': 'Loyang / Changi',
      'D18': 'Tampines / Pasir Ris',
      'D19': 'Serangoon Garden / Hougang / Sengkang / Punggol',
      'D20': 'Bishan / Ang Mo Kio',
      'D21': 'Upper Bukit Timah / Clementi Park / Ulu Pandan',
      'D22': 'Jurong / Boon Lay / Tuas',
      'D23': 'Bukit Batok / Bukit Panjang / Choa Chu Kang',
      'D24': 'Lim Chu Kang / Tengah',
      'D25': 'Kranji / Woodlands',
      'D26': 'Upper Thomson / Springleaf',
      'D27': 'Yishun / Sembawang',
      'D28': 'Seletar / Yio Chu Kang',
    };

    const getDistrictLabel = (district) => {
      return DISTRICT_NAMES[district] ? `${district} (${DISTRICT_NAMES[district]})` : district;
    };

    const formatPrice = (value) => {
      if (!value) return '-';
      if (value >= 1000000000) return `$${(value / 1000000000).toFixed(2)}B`;  // Billions with 2 decimals
      if (value >= 1000000) return `$${(value / 1000000).toFixed(1)}M`;
      return `$${(value / 1000).toFixed(0)}K`;
    };

    const formatPriceMedian = (value) => {
      if (!value) return '-';
      if (value >= 1000000) return `$${(value / 1000000).toFixed(2)}M`;
      return `$${(value / 1000).toFixed(2)}K`;
    };

    const formatPSF = (value) => value ? `$${Math.round(value).toLocaleString()}` : '-';

    const renderStat = (obj, key, formatter) => {
      if (!obj) return '-';
      if (obj.insufficient) return 'Insufficient Data';
      const val = obj[key];
      return val ? formatter(val) : '-';
    };

    // Format date as "Dec 2025" (URA format)
    const formatDate = (dateStr) => {
      if (!dateStr) return '-';
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return '-';
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return `${months[date.getMonth()]} ${date.getFullYear()}`;
      } catch (e) {
        return '-';
      }
    };

    // Bedroom Filter
    const BedroomFilter = ({ selected, onChange }) => (
      <div style={{ display: 'flex', gap: '8px', alignItems: 'center', flexWrap: 'wrap' }}>
        <span style={{ fontWeight: 500, color: '#374151', marginRight: '8px' }}>
          Filter by Bedroom:
        </span>
        {['2b', '3b', '4b'].map((opt) => (
          <button
            key={opt}
            onClick={() => {
              if (selected.includes(opt)) {
                if (selected.length > 1) onChange(selected.filter(s => s !== opt));
              } else {
                onChange([...selected, opt]);
              }
            }}
            style={{
              padding: '8px 16px',
              borderRadius: '8px',
              border: 'none',
              cursor: 'pointer',
              fontWeight: 500,
              transition: 'all 0.2s',
              background: selected.includes(opt) ? COLORS[opt] : '#E5E7EB',
              color: selected.includes(opt) ? 'white' : '#6B7280',
            }}
          >
            {BEDROOM_LABELS[opt]}
          </button>
        ))}
      </div>
    );

    // Card Component
    const Card = ({ title, children }) => (
      <div style={{
        background: 'white',
        borderRadius: '12px',
        padding: '24px',
        boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
        marginBottom: '24px'
      }}>
        <h2 style={{ 
          fontSize: '18px', 
          fontWeight: 600, 
          color: '#111827', 
          marginBottom: '20px',
          borderBottom: '2px solid #E5E7EB',
          paddingBottom: '12px'
        }}>
          {title}
        </h2>
        {children}
      </div>
    );

    // Chart.js Line Chart Component
    const LineChartComponent = ({ data, selectedBedrooms, valueFormatter, title }) => {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!canvasRef.current || !data || data.length === 0) {
          console.log('LineChart: Missing requirements', {
            canvas: !!canvasRef.current,
            data: !!data,
            dataLength: data?.length
          });
          return;
        }

        if (typeof Chart === 'undefined') {
          console.error('LineChart: Chart.js not loaded');
          return;
        }

        const ctx = canvasRef.current.getContext('2d');
        
        // Destroy existing chart
        if (chartRef.current) {
          chartRef.current.destroy();
          chartRef.current = null;
        }

        const datasets = [];
        if (selectedBedrooms.includes('2b')) {
          // Use null for missing data - Chart.js will bridge gaps with spanGaps: true
          const values = data.map(d => {
            const val = d['2b_price'];
            // Return null for missing data - Chart.js will draw a line across it
            return (val != null && val !== undefined && !isNaN(val)) ? val : null;
          });
          datasets.push({
            label: '2-Bedroom',
            data: values,
            borderColor: COLORS['2b'],
            backgroundColor: COLORS['2b'] + '20',
            tension: 0.4,
            spanGaps: true,  // Bridge gaps: draw continuous line across null values
            pointRadius: function(context) {
              // Only show points where we have actual data (not null)
              if (context.parsed.y == null) return 0;
              // Show larger point with warning color if low sample size
              const dataIndex = context.dataIndex;
              const originalData = data[dataIndex];
              const isLowSample = originalData?.['2b_low_sample'] || false;
              return isLowSample ? 6 : 4; // Larger point for low sample
            },
            pointBackgroundColor: function(context) {
              // Use warning color (orange/red) for low sample sizes
              if (context.parsed.y == null) return COLORS['2b'];
              const dataIndex = context.dataIndex;
              const originalData = data[dataIndex];
              const isLowSample = originalData?.['2b_low_sample'] || false;
              return isLowSample ? '#F59E0B' : COLORS['2b']; // Orange for low sample
            },
            pointHoverRadius: 6,
            pointHitRadius: 10
          });
        }
        if (selectedBedrooms.includes('3b')) {
          const values = data.map(d => {
            const val = d['3b_price'];
            return (val != null && val !== undefined && !isNaN(val)) ? val : null;
          });
          datasets.push({
            label: '3-Bedroom',
            data: values,
            borderColor: COLORS['3b'],
            backgroundColor: COLORS['3b'] + '20',
            tension: 0.4,
            spanGaps: true,  // Bridge gaps: draw continuous line across null values
            pointRadius: function(context) {
              if (context.parsed.y == null) return 0;
              const dataIndex = context.dataIndex;
              const originalData = data[dataIndex];
              const isLowSample = originalData?.['3b_low_sample'] || false;
              return isLowSample ? 6 : 4;
            },
            pointBackgroundColor: function(context) {
              if (context.parsed.y == null) return COLORS['3b'];
              const dataIndex = context.dataIndex;
              const originalData = data[dataIndex];
              const isLowSample = originalData?.['3b_low_sample'] || false;
              return isLowSample ? '#F59E0B' : COLORS['3b'];
            },
            pointHoverRadius: 6,
            pointHitRadius: 10
          });
        }
        if (selectedBedrooms.includes('4b')) {
          const values = data.map(d => {
            const val = d['4b_price'];
            return (val != null && val !== undefined && !isNaN(val)) ? val : null;
          });
          datasets.push({
            label: '4-Bedroom',
            data: values,
            borderColor: COLORS['4b'],
            backgroundColor: COLORS['4b'] + '20',
            tension: 0.4,
            spanGaps: true,  // Bridge gaps: draw continuous line across null values
            pointRadius: function(context) {
              if (context.parsed.y == null) return 0;
              const dataIndex = context.dataIndex;
              const originalData = data[dataIndex];
              const isLowSample = originalData?.['4b_low_sample'] || false;
              return isLowSample ? 6 : 4;
            },
            pointBackgroundColor: function(context) {
              if (context.parsed.y == null) return COLORS['4b'];
              const dataIndex = context.dataIndex;
              const originalData = data[dataIndex];
              const isLowSample = originalData?.['4b_low_sample'] || false;
              return isLowSample ? '#F59E0B' : COLORS['4b'];
            },
            pointHoverRadius: 6,
            pointHitRadius: 10
          });
        }

        if (datasets.length === 0) {
          console.warn('LineChart: No datasets to render');
          return;
        }

        try {
          const labels = data.map(d => d.month || d.quarter || '');
          console.log('LineChart: Creating chart with', datasets.length, 'datasets and', labels.length, 'labels');
          
          chartRef.current = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                intersect: false,
                mode: 'index'
              },
              plugins: {
                legend: { 
                  display: true, 
                  position: 'top' 
                },
                tooltip: {
                  filter: function(tooltipItem) {
                    // Only show tooltip for actual data points (not null)
                    return tooltipItem.parsed.y != null;
                  },
                  callbacks: {
                    label: function(context) {
                      const value = context.parsed.y;
                      if (value == null || isNaN(value)) {
                        return null; // Don't show tooltip for null values
                      }
                      const dataIndex = context.dataIndex;
                      const bedroomKey = context.dataset.label.toLowerCase().replace('-bedroom', 'b');
                      const originalData = data[dataIndex];
                      const txnCount = originalData?.[`${bedroomKey}_count`] || 0;
                      const isLowSample = originalData?.[`${bedroomKey}_low_sample`] || false;
                      
                      let label = context.dataset.label + ': ' + (valueFormatter ? valueFormatter(value) : value);
                      if (isLowSample && txnCount > 0) {
                        label += ` (⚠️ Low sample: ${txnCount} txn)`;
                      } else if (txnCount > 0) {
                        label += ` (${txnCount} txn)`;
                      }
                      return label;
                    }
                  }
                }
              },
              scales: {
                x: {
                  ticks: {
                    maxRotation: 45,
                    minRotation: 45,
                    autoSkip: false  // Show all quarter labels
                  },
                  grid: {
                    display: true
                  }
                },
                y: {
                  beginAtZero: false,
                  ticks: {
                    callback: function(value) {
                      if (value == null || isNaN(value)) return '';
                      return valueFormatter ? valueFormatter(value) : value;
                    }
                  },
                  grid: {
                    display: true
                  }
                }
              },
              elements: {
                point: {
                  radius: 4,
                  hoverRadius: 6
                },
                line: {
                  borderWidth: 2
                }
              }
            }
          });
          
          console.log('LineChart: Chart created successfully');
        } catch (error) {
          console.error('LineChart: Error creating chart', error);
        }

        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
          }
        };
      }, [data, selectedBedrooms, valueFormatter]);

      return (
        <div>
          {title && <h3 style={{ fontSize: '14px', color: '#6B7280', marginBottom: '12px' }}>{title}</h3>}
          <div style={{ height: '300px', position: 'relative' }}>
            <canvas ref={canvasRef}></canvas>
          </div>
        </div>
      );
    };

    // Chart.js Bar Chart Component
    const BarChartComponent = ({ data, selectedBedrooms, valueFormatter, title, horizontal = false, stacked = false, showCountLabels = false, beginAtZero = true }) => {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        if (!canvasRef.current || !data || data.length === 0) {
          console.log('BarChart: Missing requirements', {
            canvas: !!canvasRef.current,
            data: !!data,
            dataLength: data?.length
          });
          return;
        }

        if (typeof Chart === 'undefined') {
          console.error('BarChart: Chart.js not loaded');
          return;
        }

        const ctx = canvasRef.current.getContext('2d');
        
        if (chartRef.current) {
          chartRef.current.destroy();
          chartRef.current = null;
        }

        const datasets = [];
        if (selectedBedrooms.includes('2b')) {
          // For bar charts: safely handle null/undefined values, default to 0
          const values = data.map(d => {
            // Check multiple possible field names and safely convert to number
            const val = d['2b'] ?? d['2b_count'] ?? d['2B'] ?? d['2B_count'] ?? null;
            // Convert to number, defaulting to 0 for null/undefined/NaN
            const numVal = (val != null && val !== undefined && !isNaN(val)) ? Number(val) : 0;
            return Math.max(0, numVal); // Ensure non-negative
          });
          datasets.push({
            label: '2-Bedroom',
            data: values,
            backgroundColor: COLORS['2b']
          });
        }
        if (selectedBedrooms.includes('3b')) {
          const values = data.map(d => {
            const val = d['3b'] ?? d['3b_count'] ?? d['3B'] ?? d['3B_count'] ?? null;
            const numVal = (val != null && val !== undefined && !isNaN(val)) ? Number(val) : 0;
            return Math.max(0, numVal);
          });
          datasets.push({
            label: '3-Bedroom',
            data: values,
            backgroundColor: COLORS['3b']
          });
        }
        if (selectedBedrooms.includes('4b')) {
          const values = data.map(d => {
            const val = d['4b'] ?? d['4b_count'] ?? d['4B'] ?? d['4B_count'] ?? null;
            const numVal = (val != null && val !== undefined && !isNaN(val)) ? Number(val) : 0;
            return Math.max(0, numVal);
          });
          datasets.push({
            label: '4-Bedroom',
            data: values,
            backgroundColor: COLORS['4b']
          });
        }

        if (datasets.length === 0) {
          console.warn('BarChart: No datasets to render');
          return;
        }

        try {
          const labels = data.map(d => d.month || d.district || d.quarter || '');
          console.log('BarChart: Creating chart with', datasets.length, 'datasets and', labels.length, 'labels');
          
          const chartOptions = {
            indexAxis: horizontal ? 'y' : 'x',
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: 'index'
            },
            plugins: {
              legend: { display: true, position: 'top' },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.parsed[horizontal ? 'x' : 'y'];
                    if (value == null || isNaN(value)) {
                      return context.dataset.label + ': No data';
                    }
                    return context.dataset.label + ': ' + (valueFormatter ? valueFormatter(value) : value);
                  }
                }
              }
            },
            scales: {
              [horizontal ? 'x' : 'y']: {
                beginAtZero: beginAtZero,
                stacked: stacked,
                ticks: {
                  callback: function(value) {
                    if (value == null || isNaN(value)) return '';
                    return valueFormatter ? valueFormatter(value) : value;
                  }
                }
              },
              [horizontal ? 'y' : 'x']: {
                stacked: stacked,
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                  autoSkip: false  // Show all quarter labels
                }
              }
            }
          };
          
          // Add animation callback for count labels if needed
          if (showCountLabels) {
            chartOptions.animation = {
              onComplete: function() {
                const chart = this.chart;
                const ctx = chart.ctx;
                ctx.save();
                
                // Get the last dataset (top of stacked bars)
                const lastDatasetIndex = chart.data.datasets.length - 1;
                const meta = chart.getDatasetMeta(lastDatasetIndex);
                
                meta.data.forEach((bar, index) => {
                  const dataIndex = index;
                  const row = data[dataIndex];
                  if (!row) return;
                  
                  // Calculate total count for this district
                  let totalCount = 0;
                  if (selectedBedrooms.includes('2b')) totalCount += (row['2b_count'] || 0);
                  if (selectedBedrooms.includes('3b')) totalCount += (row['3b_count'] || 0);
                  if (selectedBedrooms.includes('4b')) totalCount += (row['4b_count'] || 0);
                  
                  if (totalCount > 0) {
                    const yPos = bar.y;
                    ctx.fillStyle = '#374151';
                    ctx.font = '500 11px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    ctx.fillText(totalCount.toLocaleString(), bar.x, yPos - 5);
                  }
                });
                
                ctx.restore();
              }
            };
          }
          
          chartRef.current = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: datasets
            },
            options: chartOptions
          });
          
          console.log('BarChart: Chart created successfully');
        } catch (error) {
          console.error('BarChart: Error creating chart', error);
        }

        return () => {
          if (chartRef.current) {
            chartRef.current.destroy();
          }
        };
      }, [data, selectedBedrooms, valueFormatter, horizontal, stacked, showCountLabels, beginAtZero]);

      return (
        <div>
          {title && <h3 style={{ fontSize: '14px', color: '#6B7280', marginBottom: '12px' }}>{title}</h3>}
          <div style={{ height: horizontal ? '400px' : '300px', position: 'relative' }}>
            <canvas ref={canvasRef}></canvas>
          </div>
        </div>
      );
    };

    // Main Dashboard
    function Dashboard() {
      const [selectedBedrooms, setSelectedBedrooms] = useState(['2b', '3b', '4b']);
      const [priceTrends, setPriceTrends] = useState([]);
      const [volumeData, setVolumeData] = useState([]);
      const [psfData, setPsfData] = useState([]);
      const [latestTransactions, setLatestTransactions] = useState([]);
      const [expandedDistricts, setExpandedDistricts] = useState({});
      const [districtProjects, setDistrictProjects] = useState({});
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [currentPage, setCurrentPage] = useState(1);
      const [sortBy, setSortBy] = useState('total'); // 'total', 'district', or 'quantity'
      const transactionsPerPage = 20;
      const [selectedMetrics, setSelectedMetrics] = useState({
        volume: true,
        psf: true,
        avgPrice: true,
        qty: true
      });
      const [marketStatsByDistrict, setMarketStatsByDistrict] = useState(null);
      // Isolated bedroom filter for District Summary (Price) section - independent from global filter
      // Default: all bedrooms checked
      const [priceSectionBedrooms, setPriceSectionBedrooms] = useState(['2b', '3b', '4b']);
      const [sqftRange, setSqftRange] = useState({ min: null, max: null });
      const [priceSectionLoading, setPriceSectionLoading] = useState(false);
      const [priceSortBy, setPriceSortBy] = useState('median_price'); // 'none', 'median_price', 'median_psf'
      const [priceSortTimeframe, setPriceSortTimeframe] = useState('short_term'); // 'short_term' or 'long_term'
      const [priceDistrictProjects, setPriceDistrictProjects] = useState({});
      const [priceExpandedDistricts, setPriceExpandedDistricts] = useState({});
      const [saleTypeTrends, setSaleTypeTrends] = useState([]);
      const [priceTrendsBySaleType, setPriceTrendsBySaleType] = useState({});
      const [availableDistricts, setAvailableDistricts] = useState([]);
      const [selectedDistrict, setSelectedDistrict] = useState('all'); // 'all' means no filter

      // Comparable Value Analysis (Buy Box)
      const BUY_BOX_MIN = 1000000;
      const BUY_BOX_MAX = 4000000;
      const BUY_BOX_STEP = 250000;
      const PRICE_BAND = 100000;
      const [buyBoxTargetPrice, setBuyBoxTargetPrice] = useState(2500000);
      const [buyBoxData, setBuyBoxData] = useState({ points: [], competitors: [], summary: {} });
      const [buyBoxLoading, setBuyBoxLoading] = useState(false);
      
      // Memoize transaction count chart data to prevent re-renders
      const transactionCountData = useMemo(() => {
        if (!priceTrends || priceTrends.length === 0) return [];
        return priceTrends.map(d => ({
          month: d.month,
          '2b_count': d['2b_count'] || 0,
          '3b_count': d['3b_count'] || 0,
          '4b_count': d['4b_count'] || 0
        }));
      }, [priceTrends]);

      // Scatter component for Comparable Value Analysis
      const BuyBoxScatter = ({ data, targetPrice, priceBand }) => {
        const canvasRef = useRef(null);
        const chartRef = useRef(null);

        useEffect(() => {
          if (!canvasRef.current) return;
          if (typeof Chart === 'undefined') return;

          const ctx = canvasRef.current.getContext('2d');

          if (chartRef.current) {
            chartRef.current.destroy();
            chartRef.current = null;
          }

          const points = (data || []).map(p => {
            const bedKey = `${p.bedroom_count}b`;
            const color =
              bedKey === '2b' ? COLORS['2b'] :
              bedKey === '3b' ? COLORS['3b'] :
              bedKey === '4b' ? COLORS['4b'] :
              '#6B7280';

            const isYoung = p.remaining_lease != null && p.remaining_lease >= 90;

            return {
              x: p.area_sqft || 0,
              y: p.price_mid || 0,
              bedroom: bedKey,
              district: p.district,
              project: p.project_name,
              minPrice: p.price_min,
              maxPrice: p.price_max,
              remaining_lease: p.remaining_lease,
              backgroundColor: color,
              borderColor: isYoung ? COLORS['young'] : color,
              radius: isYoung ? 7 : 5,
              borderWidth: isYoung ? 2 : 1.5
            };
          });

          chartRef.current = new Chart(ctx, {
            type: 'scatter',
            data: {
              datasets: [
                {
                  label: 'Projects',
                  data: points,
                  parsing: false,
                  pointBackgroundColor: points.map(p => p.backgroundColor),
                  pointBorderColor: points.map(p => p.borderColor),
                  pointRadius: points.map(p => p.radius),
                  pointBorderWidth: points.map(p => p.borderWidth)
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: (ctx) => {
                      const d = ctx.raw;
                      if (!d) return '';
                      const range = `$${Math.round(d.minPrice / 1000).toLocaleString()}k - $${Math.round(d.maxPrice / 1000).toLocaleString()}k`;
                      const lease = d.remaining_lease != null ? `, Remaining lease: ${d.remaining_lease} yrs` : '';
                      return `${d.project} (${d.district}, ${d.bedroom.toUpperCase()}): ${Math.round(d.x).toLocaleString()} sqft, ${range}${lease}`;
                    }
                  }
                }
              },
              layout: {
                padding: { top: 24, right: 16, bottom: 16, left: 8 }
              },
              scales: {
                x: {
                  title: { display: true, text: 'Area (sqft)' },
                  ticks: { callback: (v) => v.toLocaleString() }
                },
                y: {
                  title: { display: true, text: 'Transacted Price ($)' },
                  ticks: { callback: (v) => '$' + (v / 1000000).toFixed(2) + 'M' }
                }
              }
            }
          });

          return () => {
            if (chartRef.current) {
              chartRef.current.destroy();
            }
          };
        }, [data, targetPrice, priceBand]);

        return (
          <div style={{ height: '320px', position: 'relative' }}>
            <canvas ref={canvasRef}></canvas>
            <div style={{ marginTop: '8px', fontSize: '11px', color: '#6B7280' }}>
              Dot colour encodes bedroom size (2B / 3B / 4B). Dark-bordered dots indicate young properties (remaining lease ≥ 90 years).
            </div>
          </div>
        );
      };

      // Fetch available districts on mount
      useEffect(() => {
        const fetchDistricts = async () => {
          try {
            const response = await fetch(`${API_BASE}/districts`);
            if (response.ok) {
              const data = await response.json();
              setAvailableDistricts(data.districts || []);
            }
          } catch (error) {
            console.error('Error fetching districts:', error);
          }
        };
        fetchDistricts();
      }, []);

      useEffect(() => {
        const fetchData = async () => {
          setLoading(true);
          setError(null);
          const bedroomParam = selectedBedrooms.map(b => b.replace('b', '')).join(',');
          const districtParam = selectedDistrict !== 'all' ? selectedDistrict : '';
          
          try {
            // Build query parameters
            const baseParams = `bedroom=${bedroomParam}`;
            const districtQuery = districtParam ? `&districts=${districtParam}` : '';
            
            // Fetch core data (required) - limit transactions to 200000 to include all New Sale + Resale
            const [trendsRes, volumeRes, psfRes, transactionsRes, saleTypeRes, priceTrendsBySaleTypeRes] = await Promise.all([
              fetch(`${API_BASE}/price_trends?${baseParams}${districtQuery}`),
              fetch(`${API_BASE}/total_volume?${baseParams}${districtQuery}`),
              fetch(`${API_BASE}/avg_psf?${baseParams}${districtQuery}`),
              fetch(`${API_BASE}/transactions?${baseParams}&limit=200000${districtQuery}`),
              fetch(`${API_BASE}/sale_type_trends${districtQuery}`).catch(() => null), // Optional, don't fail if missing
              fetch(`${API_BASE}/price_trends_by_sale_type?${baseParams}${districtQuery}`).catch(() => null) // Optional, don't fail if missing
            ]);
            
            if (!trendsRes.ok || !volumeRes.ok || !psfRes.ok) {
              throw new Error('API request failed');
            }
            
            const [trends, volume, psf, transactions, saleTypeData, priceTrendsBySaleTypeData] = await Promise.all([
              trendsRes.json(), 
              volumeRes.json(), 
              psfRes.json(),
              transactionsRes.ok ? transactionsRes.json() : { transactions: [] },
              saleTypeRes && saleTypeRes.ok ? saleTypeRes.json() : { trends: [] },
              priceTrendsBySaleTypeRes && priceTrendsBySaleTypeRes.ok ? priceTrendsBySaleTypeRes.json() : { trends: {} }
            ]);
            
            setPriceTrends(trends.trends || []);
            setVolumeData(volume.data || []);
            setPsfData(psf.data || []);
            setSaleTypeTrends(saleTypeData.trends || []);
            setPriceTrendsBySaleType(priceTrendsBySaleTypeData.trends || {});
            // Sort by transaction_date descending (newest first) - limit to 20 for display
            const sorted = (transactions.transactions || []).sort((a, b) => {
              const dateA = a.transaction_date ? new Date(a.transaction_date) : new Date(0);
              const dateB = b.transaction_date ? new Date(b.transaction_date) : new Date(0);
              return dateB - dateA;
            });
            setLatestTransactions(sorted);
            setCurrentPage(1); // Reset to first page when data changes
          } catch (err) {
            console.error('Error fetching data:', err);
            setError(err.message);
          } finally {
            setLoading(false);
          }
        };
        fetchData();
      }, [selectedBedrooms, selectedDistrict]);

      // Separate effect for market stats by district (uses isolated priceSectionBedrooms filter)
      useEffect(() => {
        const emptyStats = {
          short_term: { by_district: {} },
          long_term: { by_district: {} }
        };

        const fetchMarketStats = async () => {
          if (priceSectionBedrooms.length === 0) {
            setMarketStatsByDistrict(emptyStats);
            setSqftRange({ min: null, max: null });
            setPriceSectionLoading(false);
            return;
          }
          
          setPriceSectionLoading(true);
          try {
            const bedroomParamForPrice = priceSectionBedrooms.map(b => b.replace('b', '')).join(',');
            const districtQuery = selectedDistrict !== 'all' ? `&districts=${selectedDistrict}` : '';
            const [marketStatsRes, transactionsRes] = await Promise.all([
              fetch(`${API_BASE}/market_stats_by_district?bedroom=${bedroomParamForPrice}${districtQuery}&short_months=3&long_months=15`),
              fetch(`${API_BASE}/transactions?bedroom=${bedroomParamForPrice}&limit=200000${districtQuery}`)
            ]);
            
            if (marketStatsRes.ok) {
              const marketStats = await marketStatsRes.json();
              setMarketStatsByDistrict(marketStats);
            } else {
              setMarketStatsByDistrict(emptyStats);
            }
            
            // Calculate sqft range
            if (transactionsRes.ok) {
              const transactionsData = await transactionsRes.json();
              const transactions = transactionsData.transactions || [];
              if (transactions.length > 0) {
                const areas = transactions
                  .map(t => t.area_sqft)
                  // Guard against corrupted or outlier values (e.g. mis-keyed 619834 sqft)
                  .filter(area => area != null && area > 0 && area <= 10000);
                if (areas.length > 0) {
                  const min = Math.min(...areas);
                  const max = Math.max(...areas);
                  setSqftRange({ min: Math.round(min), max: Math.round(max) });
                } else {
                  setSqftRange({ min: null, max: null });
                }
              } else {
                setSqftRange({ min: null, max: null });
              }
            }
          } catch (err) {
            console.error('Error fetching market stats by district:', err);
            setMarketStatsByDistrict(emptyStats);
          } finally {
            setPriceSectionLoading(false);
          }
        };
        
        fetchMarketStats();
      }, [priceSectionBedrooms, selectedDistrict]);

      // Fetch Comparable Value Analysis whenever target price or filters change
      useEffect(() => {
        const fetchBuyBox = async () => {
          setBuyBoxLoading(true);
          try {
            const bedroomParam = selectedBedrooms.map(b => b.replace('b', '')).join(',');
            const districtParam = selectedDistrict !== 'all' ? `&districts=${selectedDistrict}` : '';
            const url = `${API_BASE}/comparable_value_analysis?target_price=${buyBoxTargetPrice}&band=${PRICE_BAND}&bedroom=${bedroomParam}${districtParam}`;
            const res = await fetch(url);
            if (res.ok) {
              const data = await res.json();
              setBuyBoxData({
                points: data.points || [],
                competitors: data.competitors || [],
                summary: data.summary || {}
              });
            } else {
              setBuyBoxData({ points: [], competitors: [], summary: {} });
            }
          } catch (err) {
            console.error('Error fetching comparable value analysis:', err);
            setBuyBoxData({ points: [], competitors: [], summary: {} });
          } finally {
            setBuyBoxLoading(false);
          }
        };

        fetchBuyBox();
      }, [buyBoxTargetPrice, selectedBedrooms, selectedDistrict]);


      // Fetch project aggregations for a specific district when expanded (Volume & Liquidity)
      const fetchDistrictProjects = async (district) => {
        if (districtProjects[district]) return; // Already loaded
        
        const bedroomParam = selectedBedrooms.map(b => b.replace('b', '')).join(',');
        try {
          const res = await fetch(`${API_BASE}/projects_by_district?district=${district}&bedroom=${bedroomParam}`);
          if (res.ok) {
            const data = await res.json();
            setDistrictProjects(prev => ({
              ...prev,
              [district]: data.projects || []
            }));
          }
        } catch (err) {
          console.error('Error fetching district projects:', err);
        }
      };

      // Fetch price project breakdown for a specific district (Price section)
      const fetchPriceDistrictProjects = async (district, monthsForView) => {
        // Normalise cache key to match viewKey used in the table ('short_term' | 'long_term')
        const viewKey = monthsForView === 3 ? 'short_term' : 'long_term';
        const key = `${district}_${viewKey}`;
        if (priceDistrictProjects[key]) return;

        const bedroomParam = priceSectionBedrooms.map(b => b.replace('b', '')).join(',');
        try {
          const res = await fetch(
            `${API_BASE}/price_projects_by_district?district=${district}&bedroom=${bedroomParam}&months=${monthsForView}`
          );
          if (res.ok) {
            const data = await res.json();
            setPriceDistrictProjects(prev => ({
              ...prev,
              [key]: data.projects || []
            }));
          }
        } catch (err) {
          console.error('Error fetching price projects by district:', err);
        }
      };

      const togglePriceDistrict = (district) => {
        const isExpanded = !!priceExpandedDistricts[district];
        setPriceExpandedDistricts(prev => ({
          ...prev,
          [district]: !isExpanded
        }));

        if (!isExpanded) {
          const monthsForView = priceSortTimeframe === 'short_term' ? 3 : 15;
          fetchPriceDistrictProjects(district, monthsForView);
        }
      };

      const toggleDistrict = (district) => {
        const isExpanded = expandedDistricts[district];
        setExpandedDistricts(prev => ({
          ...prev,
          [district]: !isExpanded
        }));
        
        if (!isExpanded && !districtProjects[district]) {
          fetchDistrictProjects(district);
        }
      };

      if (error) {
        return (
          <div style={{ padding: '32px', maxWidth: '800px', margin: '0 auto' }}>
            <div style={{
              background: '#FEE2E2',
              border: '1px solid #FCA5A5',
              borderRadius: '12px',
              padding: '24px',
              textAlign: 'center'
            }}>
              <h2 style={{ color: '#DC2626', marginBottom: '12px' }}>⚠️ Connection Error</h2>
              <p style={{ color: '#7F1D1D', marginBottom: '16px' }}>
                Cannot connect to API. Please start the Flask backend:
              </p>
              <code style={{ 
                display: 'block', 
                background: '#FEF2F2', 
                padding: '12px', 
                borderRadius: '6px',
                color: '#991B1B'
              }}>
                cd condo_api && python app.py
              </code>
            </div>
          </div>
        );
      }

      return (
        <div style={{ padding: '32px', maxWidth: '1400px', margin: '0 auto' }}>
          {/* Header */}
          <div style={{ marginBottom: '32px' }}>
            <h1 style={{ fontSize: '28px', fontWeight: 700, color: '#111827', marginBottom: '8px' }}>
              Singapore Private Condo Resale Statistics
            </h1>
            <p style={{ color: '#6B7280', fontSize: '16px' }}>
              Transaction data breakdown by postal district and bedroom type
            </p>
          </div>

          {/* Filter */}
          <div style={{ 
            background: 'white', 
            padding: '16px 24px', 
            borderRadius: '12px',
            marginBottom: '24px',
            boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
            display: 'flex',
            flexDirection: 'column',
            gap: '16px'
          }}>
            <BedroomFilter selected={selectedBedrooms} onChange={setSelectedBedrooms} />
            
            {/* District Filter */}
            <div style={{ 
              display: 'flex', 
              alignItems: 'center', 
              gap: '12px',
              flexWrap: 'wrap'
            }}>
              <label style={{ 
                fontSize: '14px', 
                fontWeight: 500, 
                color: '#374151',
                minWidth: '120px'
              }}>
                Filter by District:
              </label>
              <select
                value={selectedDistrict}
                onChange={(e) => setSelectedDistrict(e.target.value)}
                style={{
                  padding: '8px 12px',
                  fontSize: '14px',
                  border: '1px solid #D1D5DB',
                  borderRadius: '6px',
                  backgroundColor: 'white',
                  color: '#111827',
                  cursor: 'pointer',
                  minWidth: '300px'
                }}
              >
                <option value="all">All Districts</option>
                {availableDistricts.map(district => {
                  const districtNames = {
                    'D01': 'Boat Quay / Raffles Place / Marina Downtown / Suntec City',
                    'D02': 'Shenton Way / Tanjong Pagar',
                    'D03': 'Queenstown / Alexandra / Tiong Bahru',
                    'D04': 'Harbourfront / Keppel / Telok Blangah',
                    'D05': 'Buona Vista / Dover / Pasir Panjang',
                    'D06': 'City Hall / Fort Canning',
                    'D07': 'Bugis / Rochor',
                    'D08': 'Little India / Farrer Park',
                    'D09': 'Orchard / Somerset / River Valley',
                    'D10': 'Tanglin / Bukit Timah / Holland',
                    'D11': 'Newton / Novena / Dunearn / Watten',
                    'D12': 'Balestier / Whampoa / Toa Payoh / Boon Keng / Bendemeer / Kampong Bugis',
                    'D13': 'Potong Pasir / Bidadari / MacPherson / Upper Aljunied',
                    'D14': 'Geylang / Dakota / Paya Lebar Central / Eunos / Ubi / Aljunied',
                    'D15': 'Tanjong Rhu / Amber / Meyer / Katong / Dunman / Joo Chiat / Marine Parade',
                    'D16': 'Bedok / Upper East Coast / Eastwood / Kew Drive',
                    'D17': 'Loyang / Changi',
                    'D18': 'Tampines / Pasir Ris',
                    'D19': 'Punggol / Sengkang',
                    'D20': 'Ang Mo Kio / Bishan',
                    'D21': 'Upper Bukit Timah / Clementi / Jurong West',
                    'D22': 'Boon Lay / Jurong East / Tuas',
                    'D23': 'Bukit Panjang / Choa Chu Kang',
                    'D24': 'Lim Chu Kang / Tengah',
                    'D25': 'Kranji / Woodlands',
                    'D26': 'Upper Thomson / Springleaf',
                    'D27': 'Yishun / Sembawang',
                    'D28': 'Seletar / Yio Chu Kang'
                  };
                  const placeNames = districtNames[district] || '';
                  return (
                    <option key={district} value={district}>
                      {district}: {placeNames ? `(${placeNames})` : ''}
                    </option>
                  );
                })}
              </select>
            </div>
          </div>

          {loading ? (
            <div style={{ textAlign: 'center', padding: '60px', color: '#6B7280' }}>
              <div style={{ fontSize: '32px', marginBottom: '12px' }}>⏳</div>
              Loading data...
            </div>
          ) : (
            <>
              {/* Chart 1: Price Trends */}
              <Card title="📈 Price Trend by Quarter (Median Price & Transaction Count)">
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: '24px' }}>
                  <LineChartComponent 
                    data={priceTrends} 
                    selectedBedrooms={selectedBedrooms}
                    valueFormatter={formatPrice}
                    title="Median Price"
                  />
                  <BarChartComponent 
                    data={transactionCountData}
                    selectedBedrooms={selectedBedrooms}
                    title="Transaction Count"
                    beginAtZero={false}
                  />
                  </div>
              </Card>

              {/* Chart: Price Comparison by Sale Type (New Sale vs Resale) */}
              {priceTrendsBySaleType && Object.keys(priceTrendsBySaleType).length > 0 && (
                <Card title="💰 Median Price: New Sale vs Resale by Bedroom Type">
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: '24px' }}>
                    {['2b', '3b', '4b'].map(bedroomKey => {
                      const bedroomData = priceTrendsBySaleType[bedroomKey];
                      if (!bedroomData || bedroomData.length === 0) return null;
                      
                      const SaleTypePriceChart = () => {
                        const canvasRef = useRef(null);
                        const chartRef = useRef(null);

                        useEffect(() => {
                          if (!canvasRef.current || !bedroomData || bedroomData.length === 0) {
                            return;
                          }

                          if (typeof Chart === 'undefined') {
                            console.error('SaleTypePriceChart: Chart.js not loaded');
                            return;
                          }

                          const ctx = canvasRef.current.getContext('2d');
                          
                          if (chartRef.current) {
                            chartRef.current.destroy();
                            chartRef.current = null;
                          }

                          const labels = bedroomData.map(d => d.quarter || '');
                          // Convert null/undefined to NaN for Chart.js to properly show gaps
                          const newSaleData = bedroomData.map(d => {
                            const val = d.new_sale;
                            return (val == null || val === undefined) ? NaN : val;
                          });
                          const resaleData = bedroomData.map(d => {
                            const val = d.resale;
                            return (val == null || val === undefined) ? NaN : val;
                          });

                          chartRef.current = new Chart(ctx, {
                            type: 'line',
                            data: {
                              labels: labels,
                              datasets: [
                                {
                                  label: 'New Sale',
                                  data: newSaleData,
                                  borderColor: '#10B981',
                                  backgroundColor: '#10B981' + '20',
                                  tension: 0.4,
                                  spanGaps: false,  // Show gaps for missing data
                                  pointRadius: 4,
                                  pointHoverRadius: 6,
                                  pointHitRadius: 10,
                                  fill: false
                                },
                                {
                                  label: 'Resale',
                                  data: resaleData,
                                  borderColor: '#3B82F6',
                                  backgroundColor: '#3B82F6' + '20',
                                  tension: 0.4,
                                  spanGaps: false,  // Show gaps for missing data
                                  pointRadius: 4,
                                  pointHoverRadius: 6,
                                  pointHitRadius: 10,
                                  fill: false
                                }
                              ]
                            },
                            options: {
                              responsive: true,
                              maintainAspectRatio: false,
                              interaction: {
                                intersect: false,
                                mode: 'index'
                              },
                              plugins: {
                                legend: { display: true, position: 'top' },
                                tooltip: {
                                  callbacks: {
                                    label: function(context) {
                                      const value = context.parsed.y;
                                      if (value == null || isNaN(value)) {
                                        return context.dataset.label + ': No data';
                                      }
                                      return context.dataset.label + ': ' + formatPrice(value);
                                    }
                                  }
                                }
                              },
                              scales: {
                                y: {
                                  beginAtZero: false,
                                  ticks: {
                                    callback: function(value) {
                                      return formatPrice(value);
                                    }
                                  }
                                },
                                x: {
                                  ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    autoSkip: false  // Show all quarter labels
                                  }
                                }
                              }
                            }
                          });

                          return () => {
                            if (chartRef.current) {
                              chartRef.current.destroy();
                            }
                          };
                        }, [bedroomData]);

                        return (
                  <div>
                            <h3 style={{ fontSize: '14px', color: '#6B7280', marginBottom: '12px' }}>
                              {bedroomKey === '2b' ? '2-Bedroom' : bedroomKey === '3b' ? '3-Bedroom' : '4-Bedroom'}
                            </h3>
                            <div style={{ height: '300px', position: 'relative' }}>
                              <canvas ref={canvasRef}></canvas>
                  </div>
                </div>
                        );
                      };

                      return <SaleTypePriceChart key={bedroomKey} />;
                    })}
                  </div>
              </Card>
              )}

              {/* Chart: New Sale vs Resale */}
              {saleTypeTrends.length > 0 && (
                <Card title="📊 Transaction Count: New Sale vs Resale">
                  {(() => {
                    const SaleTypeChart = () => {
                      const canvasRef = useRef(null);
                      const chartRef = useRef(null);

                      useEffect(() => {
                        if (!canvasRef.current || !saleTypeTrends || saleTypeTrends.length === 0) {
                          return;
                        }

                        if (typeof Chart === 'undefined') {
                          console.error('SaleTypeChart: Chart.js not loaded');
                          return;
                        }

                        const ctx = canvasRef.current.getContext('2d');
                        
                        if (chartRef.current) {
                          chartRef.current.destroy();
                          chartRef.current = null;
                        }

                        const labels = saleTypeTrends.map(d => d.quarter || '');
                        const newSaleData = saleTypeTrends.map(d => d.new_sale || 0);
                        const resaleData = saleTypeTrends.map(d => d.resale || 0);

                        chartRef.current = new Chart(ctx, {
                          type: 'line',
                          data: {
                            labels: labels,
                            datasets: [
                              {
                                label: 'New Sale',
                                data: newSaleData,
                                borderColor: '#10B981',
                                backgroundColor: '#10B981' + '20',
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                pointHitRadius: 10,
                                fill: false
                              },
                              {
                                label: 'Resale',
                                data: resaleData,
                                borderColor: '#3B82F6',
                                backgroundColor: '#3B82F6' + '20',
                                tension: 0.4,
                                spanGaps: true,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                pointHitRadius: 10,
                                fill: false
                              }
                            ]
                          },
                          options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                              intersect: false,
                              mode: 'index'
                            },
                            plugins: {
                              legend: { display: true, position: 'top' },
                              tooltip: {
                                callbacks: {
                                  label: function(context) {
                                    return context.dataset.label + ': ' + (context.parsed.y || 0).toLocaleString();
                                  }
                                }
                              }
                            },
                            scales: {
                              y: {
                                beginAtZero: true,
                                ticks: {
                                  callback: function(value) {
                                    return value.toLocaleString();
                                  }
                                }
                              },
                              x: {
                                ticks: {
                                  maxRotation: 45,
                                  minRotation: 45
                                }
                              }
                            }
                          }
                        });

                        return () => {
                          if (chartRef.current) {
                            chartRef.current.destroy();
                          }
                        };
                      }, [saleTypeTrends]);

                      return (
                        <div style={{ height: '300px', position: 'relative' }}>
                          <canvas ref={canvasRef}></canvas>
                        </div>
                      );
                    };

                    return <SaleTypeChart />;
                  })()}
              </Card>
              )}

              {/* Summary Table */}
              <Card title="📋 District Summary (Volume & Liquidity)">
                {/* Filters */}
                <div style={{ 
                  marginBottom: '16px', 
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '12px'
                }}>
                  {/* Sort Filter */}
                  <div style={{ 
                    padding: '12px', 
                    background: '#F9FAFB', 
                    borderRadius: '8px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px'
                  }}>
                    <span style={{ fontWeight: 500, color: '#374151' }}>Sort by:</span>
                    <button
                      onClick={() => setSortBy('total')}
                      style={{
                        padding: '6px 12px',
                        borderRadius: '6px',
                        border: 'none',
                        background: sortBy === 'total' ? COLORS['3b'] : '#E5E7EB',
                        color: sortBy === 'total' ? 'white' : '#6B7280',
                        cursor: 'pointer',
                        fontWeight: 500,
                        fontSize: '13px'
                      }}
                    >
                      Total Volume
                    </button>
                    <button
                      onClick={() => setSortBy('quantity')}
                      style={{
                        padding: '6px 12px',
                        borderRadius: '6px',
                        border: 'none',
                        background: sortBy === 'quantity' ? COLORS['3b'] : '#E5E7EB',
                        color: sortBy === 'quantity' ? 'white' : '#6B7280',
                        cursor: 'pointer',
                        fontWeight: 500,
                        fontSize: '13px'
                      }}
                    >
                      Quantity
                    </button>
                  </div>
                </div>
                <div style={{ overflowX: 'auto' }}>
                  <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '14px' }}>
                    <thead>
                      <tr style={{ borderBottom: '2px solid #E5E7EB' }}>
                        <th style={{ padding: '12px', textAlign: 'left', width: '50px' }}></th>
                        <th style={{ padding: '12px', textAlign: 'left' }}>District</th>
                        {selectedBedrooms.includes('2b') && (
                          <>
                            {selectedMetrics.volume && <th style={{ padding: '12px', textAlign: 'right', color: COLORS['2b'] }}>2B Volume</th>}
                            {selectedMetrics.qty && <th style={{ padding: '12px', textAlign: 'right', color: COLORS['2b'] }}>2B Qty</th>}
                          </>
                        )}
                        {selectedBedrooms.includes('3b') && (
                          <>
                            {selectedMetrics.volume && <th style={{ padding: '12px', textAlign: 'right', color: COLORS['3b'] }}>3B Volume</th>}
                            {selectedMetrics.qty && <th style={{ padding: '12px', textAlign: 'right', color: COLORS['3b'] }}>3B Qty</th>}
                          </>
                        )}
                        {selectedBedrooms.includes('4b') && (
                          <>
                            {selectedMetrics.volume && <th style={{ padding: '12px', textAlign: 'right', color: COLORS['4b'] }}>4B Volume</th>}
                            {selectedMetrics.qty && <th style={{ padding: '12px', textAlign: 'right', color: COLORS['4b'] }}>4B Qty</th>}
                          </>
                        )}
                        <th style={{ padding: '12px', textAlign: 'right', fontWeight: 700 }}>Total Qty</th>
                        <th style={{ padding: '12px', textAlign: 'right', fontWeight: 700 }}>Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      {[...volumeData]
                        .sort((a, b) => {
                          if (sortBy === 'total') {
                            return (b.total || 0) - (a.total || 0); // Descending by total
                          } else if (sortBy === 'quantity') {
                            return (b.total_quantity || 0) - (a.total_quantity || 0); // Descending by quantity
                          } else {
                            return a.district.localeCompare(b.district); // Ascending by district
                          }
                        })
                        .map((row, i) => {
                        const psfRow = psfData.find(p => p.district === row.district) || {};
                        const isExpanded = expandedDistricts[row.district];
                        const projects = districtProjects[row.district] || [];
                        return (
                          <React.Fragment key={row.district}>
                            <tr style={{ 
                            borderBottom: '1px solid #E5E7EB',
                              background: i % 2 === 0 ? '#F9FAFB' : 'white',
                              cursor: 'pointer'
                            }}
                            onClick={() => toggleDistrict(row.district)}
                            >
                              <td style={{ padding: '12px', textAlign: 'center' }}>
                                <span style={{ 
                                  display: 'inline-block',
                                  transform: isExpanded ? 'rotate(90deg)' : 'rotate(0deg)',
                                  transition: 'transform 0.2s',
                                  fontSize: '12px'
                                }}>
                                  ▶
                                </span>
                              </td>
                                <td style={{ padding: '12px', fontWeight: 500 }}>{getDistrictLabel(row.district)}</td>
                            {selectedBedrooms.includes('2b') && (
                              <>
                                {selectedMetrics.volume && <td style={{ padding: '12px', textAlign: 'right' }}>{formatPrice(row['2b'])}</td>}
                                {selectedMetrics.qty && (
                                  <td style={{ padding: '12px', textAlign: 'right', color: '#6B7280' }}>
                                    {(row['2b_count'] || 0).toLocaleString()}
                                  </td>
                                )}
                              </>
                            )}
                            {selectedBedrooms.includes('3b') && (
                              <>
                                {selectedMetrics.volume && <td style={{ padding: '12px', textAlign: 'right' }}>{formatPrice(row['3b'])}</td>}
                                {selectedMetrics.qty && (
                                  <td style={{ padding: '12px', textAlign: 'right', color: '#6B7280' }}>
                                    {(row['3b_count'] || 0).toLocaleString()}
                                  </td>
                                )}
                              </>
                            )}
                            {selectedBedrooms.includes('4b') && (
                              <>
                                {selectedMetrics.volume && <td style={{ padding: '12px', textAlign: 'right' }}>{formatPrice(row['4b'])}</td>}
                                {selectedMetrics.qty && (
                                  <td style={{ padding: '12px', textAlign: 'right', color: '#6B7280' }}>
                                    {(row['4b_count'] || 0).toLocaleString()}
                                  </td>
                                )}
                              </>
                            )}
                            <td style={{ padding: '12px', textAlign: 'right', fontWeight: 600, color: '#374151' }}>
                              {(row.total_quantity || 0).toLocaleString()}
                            </td>
                            <td style={{ padding: '12px', textAlign: 'right', fontWeight: 600 }}>
                              {formatPrice(row.total)}
                            </td>
                          </tr>
                          {isExpanded && (
                            <tr>
                              <td colSpan={1 + (selectedBedrooms.length * 2) + 2} style={{ padding: '0', background: '#F9FAFB' }}>
                                <div style={{ padding: '20px', borderTop: '2px solid #E5E7EB' }}>
                                  {projects.length === 0 ? (
                                    <div style={{ textAlign: 'center', padding: '20px', color: '#6B7280' }}>Loading projects...</div>
                                  ) : (
                                    <div style={{ overflowX: 'auto' }}>
                                      <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px' }}>
                                        <thead>
                                          <tr style={{ borderBottom: '2px solid #E5E7EB', background: 'white' }}>
                                            <th style={{ padding: '10px', textAlign: 'left', fontWeight: 600 }}>Project Name</th>
                                            {selectedBedrooms.includes('2b') && (
                                              <>
                                                {selectedMetrics.volume && <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: COLORS['2b'] }}>2B Volume</th>}
                                                {selectedMetrics.qty && <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: COLORS['2b'] }}>2B Qty</th>}
                                              </>
                                            )}
                                            {selectedBedrooms.includes('3b') && (
                                              <>
                                                {selectedMetrics.volume && <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: COLORS['3b'] }}>3B Volume</th>}
                                                {selectedMetrics.qty && <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: COLORS['3b'] }}>3B Qty</th>}
                                              </>
                                            )}
                                            {selectedBedrooms.includes('4b') && (
                                              <>
                                                {selectedMetrics.volume && <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: COLORS['4b'] }}>4B Volume</th>}
                                                {selectedMetrics.qty && <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: COLORS['4b'] }}>4B Qty</th>}
                                              </>
                                            )}
                                            <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600 }}>Total Qty</th>
                                            <th style={{ padding: '10px', textAlign: 'right', fontWeight: 600 }}>Total Volume</th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          {projects.map((project, idx) => (
                                            <tr key={idx} style={{ 
                                              borderBottom: '1px solid #F3F4F6',
                                              background: idx % 2 === 0 ? 'white' : '#FAFAFA'
                                            }}>
                                              <td style={{ padding: '10px', fontWeight: 500 }}>
                                                <span>{project.project_name}</span>
                                                {project.sale_type_label && (
                                                  <span
                                                    style={{
                                                      marginLeft: '8px',
                                                      padding: '2px 8px',
                                                      borderRadius: '999px',
                                                      fontSize: '10px',
                                                      fontWeight: 600,
                                                      background:
                                                        project.sale_type_label === 'New Launch'
                                                          ? 'rgba(37, 99, 235, 0.1)'
                                                          : 'rgba(16, 185, 129, 0.1)',
                                                      color:
                                                        project.sale_type_label === 'New Launch'
                                                          ? '#2563EB'
                                                          : '#059669'
                                                    }}
                                                  >
                                                    {project.sale_type_label}
                                                  </span>
                                                )}
                                              </td>
                                              {selectedBedrooms.includes('2b') && (
                                                <>
                                                  {selectedMetrics.volume && <td style={{ padding: '10px', textAlign: 'right' }}>{formatPrice(project['2b'] || 0)}</td>}
                                                  {selectedMetrics.qty && <td style={{ padding: '10px', textAlign: 'right', color: '#6B7280' }}>{(project['2b_count'] || 0).toLocaleString()}</td>}
                                                </>
                                              )}
                                              {selectedBedrooms.includes('3b') && (
                                                <>
                                                  {selectedMetrics.volume && <td style={{ padding: '10px', textAlign: 'right' }}>{formatPrice(project['3b'] || 0)}</td>}
                                                  {selectedMetrics.qty && <td style={{ padding: '10px', textAlign: 'right', color: '#6B7280' }}>{(project['3b_count'] || 0).toLocaleString()}</td>}
                                                </>
                                              )}
                                              {selectedBedrooms.includes('4b') && (
                                                <>
                                                  {selectedMetrics.volume && <td style={{ padding: '10px', textAlign: 'right' }}>{formatPrice(project['4b'] || 0)}</td>}
                                                  {selectedMetrics.qty && <td style={{ padding: '10px', textAlign: 'right', color: '#6B7280' }}>{(project['4b_count'] || 0).toLocaleString()}</td>}
                                                </>
                                              )}
                                              <td style={{ padding: '10px', textAlign: 'right', fontWeight: 600, color: '#374151' }}>
                                                {(project.total_quantity || 0).toLocaleString()}
                                              </td>
                                              <td style={{ padding: '10px', textAlign: 'right', fontWeight: 600 }}>
                                                {formatPrice(project.total || 0)}
                                              </td>
                                            </tr>
                                          ))}
                                        </tbody>
                                      </table>
                                    </div>
                                  )}
                                </div>
                              </td>
                            </tr>
                          )}
                        </React.Fragment>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </Card>

              {/* District Summary (Price) */}
              <Card title="📊 District Summary (Price)">
                {/* Bedroom Filter */}
                <div style={{ 
                  marginBottom: '16px', 
                  padding: '12px', 
                  background: '#F9FAFB', 
                  borderRadius: '8px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '12px',
                  flexWrap: 'wrap'
                }}>
                  <span style={{ fontWeight: 500, color: '#374151' }}>Filter by Bedroom:</span>
                  {['2b', '3b', '4b'].map((opt) => (
                    <label
                      key={opt}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        cursor: 'pointer',
                        fontSize: '13px',
                        color: '#374151',
                        userSelect: 'none'
                      }}
                    >
                      <input
                        type="checkbox"
                        checked={priceSectionBedrooms.includes(opt)}
                        onChange={(e) => {
                          if (e.target.checked) {
                            setPriceSectionBedrooms([...priceSectionBedrooms, opt]);
                          } else {
                            if (priceSectionBedrooms.length > 1) {
                              setPriceSectionBedrooms(priceSectionBedrooms.filter(b => b !== opt));
                            }
                          }
                        }}
                        style={{ 
                          cursor: 'pointer',
                          width: '16px',
                          height: '16px'
                        }}
                      />
                      {BEDROOM_LABELS[opt]}
                    </label>
                  ))}
                </div>
                {/* Sort Filter for Price Section */}
                <div style={{ 
                  marginBottom: '16px', 
                  padding: '12px', 
                  background: '#F9FAFB', 
                  borderRadius: '8px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '12px',
                  flexWrap: 'wrap'
                }}>
                  <span style={{ fontWeight: 500, color: '#374151' }}>Sort by:</span>
                  <button
                    onClick={() => {
                      if (priceSortBy === 'median_price') {
                        setPriceSortBy('none');
                      } else {
                        setPriceSortBy('median_price');
                      }
                    }}
                    style={{
                      padding: '6px 12px',
                      borderRadius: '6px',
                      border: 'none',
                      background: priceSortBy === 'median_price' ? COLORS['3b'] : '#E5E7EB',
                      color: priceSortBy === 'median_price' ? 'white' : '#6B7280',
                      cursor: 'pointer',
                      fontWeight: 500,
                      fontSize: '13px'
                    }}
                  >
                    Median Price
                  </button>
                  <button
                    onClick={() => {
                      if (priceSortBy === 'median_psf') {
                        setPriceSortBy('none');
                      } else {
                        setPriceSortBy('median_psf');
                      }
                    }}
                    style={{
                      padding: '6px 12px',
                      borderRadius: '6px',
                      border: 'none',
                      background: priceSortBy === 'median_psf' ? COLORS['3b'] : '#E5E7EB',
                      color: priceSortBy === 'median_psf' ? 'white' : '#6B7280',
                      cursor: 'pointer',
                      fontWeight: 500,
                      fontSize: '13px'
                    }}
                  >
                    Median PSF
                  </button>
                  <div style={{ marginLeft: 'auto', display: 'flex', gap: '8px', alignItems: 'center' }}>
                    <span style={{ fontSize: '12px', color: '#6B7280' }}>Sort timeframe:</span>
                    <button
                      onClick={() => setPriceSortTimeframe('short_term')}
                      style={{
                        padding: '4px 8px',
                        borderRadius: '4px',
                        border: 'none',
                        background: priceSortTimeframe === 'short_term' ? '#4B5563' : '#E5E7EB',
                        color: priceSortTimeframe === 'short_term' ? '#F3F4F6' : '#6B7280',
                        cursor: 'pointer',
                        fontWeight: priceSortTimeframe === 'short_term' ? 600 : 500,
                        fontSize: '11px',
                        transition: 'all 0.2s'
                      }}
                    >
                      Last 3 Months (Pulse)
                    </button>
                    <button
                      onClick={() => setPriceSortTimeframe('long_term')}
                      style={{
                        padding: '4px 8px',
                        borderRadius: '4px',
                        border: 'none',
                        background: priceSortTimeframe === 'long_term' ? '#4B5563' : '#E5E7EB',
                        color: priceSortTimeframe === 'long_term' ? '#F3F4F6' : '#6B7280',
                        cursor: 'pointer',
                        fontWeight: priceSortTimeframe === 'long_term' ? 600 : 500,
                        fontSize: '11px',
                        transition: 'all 0.2s'
                      }}
                    >
                      Last 15 Months (Baseline)
                    </button>
                  </div>
                </div>
                {sqftRange.min != null && sqftRange.max != null && (
                  <div style={{
                    marginTop: '8px',
                    marginBottom: '16px',
                    paddingLeft: '12px',
                    fontSize: '12px',
                    color: '#6B7280'
                  }}>
                    {sqftRange.min} sqft (min) - {sqftRange.max} sqft (max)
                  </div>
                )}
                {priceSectionLoading ? (
                  <div style={{ textAlign: 'center', padding: '40px', color: '#6B7280' }}>
                    <div style={{ fontSize: '16px', marginBottom: '8px' }}>⏳</div>
                    Updating price data...
                  </div>
                ) : marketStatsByDistrict ? (
                  <div style={{ overflowX: 'auto' }}>
                    <div
                      style={{
                        textAlign: 'center',
                        marginBottom: '8px',
                        padding: '10px',
                        borderRadius: '6px',
                        background: '#4B5563',
                        color: '#F9FAFB',
                        fontWeight: 600,
                        fontSize: '14px'
                      }}
                    >
                      {priceSortTimeframe === 'short_term'
                        ? 'Last 3 months (Short-term)'
                        : 'Last 15 months (Long-term)'}
                    </div>
                    <div
                      style={{
                        textAlign: 'center',
                        fontSize: '11px',
                        color: '#6B7280',
                        marginBottom: '12px'
                      }}
                    >
                      *Only projects with at least 5 transactions in this timeframe are shown in the breakdown.
                    </div>
                    <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px' }}>
                      <thead>
                        <tr style={{ borderBottom: '2px solid #E5E7EB', background: '#F9FAFB' }}>
                          <th style={{ padding: '10px', textAlign: 'center', fontWeight: 600, width: '40px' }}></th>
                          <th style={{ padding: '10px', textAlign: 'left', fontWeight: 600 }}>District</th>
                          <th style={{ padding: '10px', textAlign: 'center', fontWeight: 600, borderRight: '2px dotted #D1D5DB' }} colSpan="3">Price ($)</th>
                          <th style={{ padding: '10px', textAlign: 'center', fontWeight: 600 }} colSpan="3">PSF ($)</th>
                        </tr>
                        <tr style={{ borderBottom: '1px solid #E5E7EB', background: '#F9FAFB' }}>
                          <th style={{ padding: '8px' }}></th>
                          <th style={{ padding: '8px', textAlign: 'left', fontSize: '11px', color: '#6B7280' }}></th>
                          <th style={{ padding: '8px', textAlign: 'center', fontSize: '11px', color: '#6B7280' }}>25th percentile</th>
                          <th style={{ padding: '8px', textAlign: 'center', fontSize: '11px', color: '#6B7280' }}>Median</th>
                          <th style={{ padding: '8px', textAlign: 'center', fontSize: '11px', color: '#6B7280', borderRight: '2px dotted #D1D5DB' }}>75th percentile</th>
                          <th style={{ padding: '8px', textAlign: 'center', fontSize: '11px', color: '#6B7280' }}>25th percentile</th>
                          <th style={{ padding: '8px', textAlign: 'center', fontSize: '11px', color: '#6B7280' }}>Median</th>
                          <th style={{ padding: '8px', textAlign: 'center', fontSize: '11px', color: '#6B7280' }}>75th percentile</th>
                        </tr>
                      </thead>
                      <tbody>
                        {(() => {
                          const viewKey = priceSortTimeframe === 'short_term' ? 'short_term' : 'long_term';
                          const byDistrict = marketStatsByDistrict[viewKey]?.by_district || {};
                          const districts = Object.keys(byDistrict);
                          let sortedDistricts = [...districts];

                          if (priceSortBy === 'median_price') {
                            sortedDistricts.sort((a, b) => {
                              const statsA = byDistrict[a];
                              const statsB = byDistrict[b];
                              const medianA = statsA?.price?.median || 0;
                              const medianB = statsB?.price?.median || 0;
                              return medianB - medianA;
                            });
                          } else if (priceSortBy === 'median_psf') {
                            sortedDistricts.sort((a, b) => {
                              const statsA = byDistrict[a];
                              const statsB = byDistrict[b];
                              const medianA = statsA?.psf?.median || 0;
                              const medianB = statsB?.psf?.median || 0;
                              return medianB - medianA;
                            });
                          } else {
                            sortedDistricts.sort();
                          }

                          return sortedDistricts.map((districtCode, i) => {
                            const stats = byDistrict[districtCode];
                            const ins = stats?.price?.insufficient || stats?.psf?.insufficient;
                            const key = `${districtCode}_${viewKey}`;
                            const isExpanded = !!priceExpandedDistricts[districtCode];
                            const projects = priceDistrictProjects[key] || [];

                            // If we've already loaded the project breakdown for this district
                            // and there are no qualifying projects (>=5 transactions),
                            // hide the entire district row from the table.
                            if (key in priceDistrictProjects && projects.length === 0) {
                              return null;
                            }

                            const renderCell = (obj, field, formatter, alignCenter) => {
                              if (!obj) return '-';
                              if (obj.insufficient) return 'NA*';
                              const val = obj[field];
                              if (val == null) return '-';
                              return formatter(val);
                            };

                            return (
                              <React.Fragment key={districtCode}>
                                <tr
                                  style={{
                                    borderBottom: '1px solid #E5E7EB',
                                    background: i % 2 === 0 ? '#F9FAFB' : 'white',
                                    cursor: 'pointer'
                                  }}
                                  onClick={() => togglePriceDistrict(districtCode)}
                                >
                                  <td style={{ padding: '10px', textAlign: 'center' }}>
                                    <span
                                      style={{
                                        display: 'inline-block',
                                        transform: isExpanded ? 'rotate(90deg)' : 'rotate(0deg)',
                                        transition: 'transform 0.2s',
                                        fontSize: '12px'
                                      }}
                                    >
                                      ▶
                                    </span>
                                  </td>
                                  <td style={{ padding: '10px', fontWeight: 500, fontSize: '12px' }}>
                                    {getDistrictLabel(districtCode)}{ins ? ' *' : ''}
                                  </td>
                                  <td style={{ padding: '10px', textAlign: 'center', color: '#6B7280', fontSize: '12px' }}>
                                    {renderCell(stats.price, '25th', formatPriceMedian)}
                                  </td>
                                  <td style={{ padding: '10px', textAlign: 'center', fontWeight: 600, fontSize: '12px' }}>
                                    {renderCell(stats.price, 'median', formatPriceMedian)}
                                  </td>
                                  <td style={{ padding: '10px', textAlign: 'center', color: '#6B7280', fontSize: '12px', borderRight: '2px dotted #D1D5DB' }}>
                                    {renderCell(stats.price, '75th', formatPriceMedian)}
                                  </td>
                                  <td style={{ padding: '10px', textAlign: 'center', color: '#6B7280', fontSize: '12px' }}>
                                    {renderCell(stats.psf, '25th', formatPSF)}
                                  </td>
                                  <td style={{ padding: '10px', textAlign: 'center', fontWeight: 600, fontSize: '12px' }}>
                                    {renderCell(stats.psf, 'median', formatPSF)}
                                  </td>
                                  <td style={{ padding: '10px', textAlign: 'center', color: '#6B7280', fontSize: '12px' }}>
                                    {renderCell(stats.psf, '75th', formatPSF)}
                                  </td>
                                </tr>
                                {isExpanded && (
                                  <tr>
                                    <td colSpan={8} style={{ padding: 0, background: '#F9FAFB' }}>
                                      <div style={{ padding: '16px 20px', borderTop: '2px solid #E5E7EB' }}>
                                        {projects.length === 0 ? (
                                          <div style={{ textAlign: 'center', padding: '16px', color: '#6B7280' }}>
                                            No projects in this timeframe.
                                          </div>
                                        ) : (
                                          <div style={{ overflowX: 'auto' }}>
                                            <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px' }}>
                                              <thead>
                                                <tr style={{ borderBottom: '2px solid #E5E7EB', background: 'white' }}>
                                                  <th style={{ padding: '8px', textAlign: 'left', fontWeight: 600 }}>
                                                    Project breakdown ({projects.length} projects)
                                                  </th>
                                                  <th style={{ padding: '8px', textAlign: 'center', fontWeight: 600 }} colSpan="3">
                                                    Price ($)
                                                  </th>
                                                  <th style={{ padding: '8px', textAlign: 'center', fontWeight: 600 }} colSpan="3">
                                                    PSF ($)
                                                  </th>
                                                  <th style={{ padding: '8px', textAlign: 'center', fontWeight: 600 }}>
                                                    Count
                                                  </th>
                                                </tr>
                                                <tr style={{ borderBottom: '1px solid #E5E7EB', background: '#F9FAFB' }}>
                                                  <th style={{ padding: '6px', textAlign: 'left', fontSize: '11px', color: '#6B7280' }}></th>
                                                  <th style={{ padding: '6px', textAlign: 'center', fontSize: '11px', color: '#6B7280' }}>25th</th>
                                                  <th style={{ padding: '6px', textAlign: 'center', fontSize: '11px', color: '#6B7280' }}>Median</th>
                                                  <th style={{ padding: '6px', textAlign: 'center', fontSize: '11px', color: '#6B7280', borderRight: '2px dotted #D1D5DB' }}>75th</th>
                                                  <th style={{ padding: '6px', textAlign: 'center', fontSize: '11px', color: '#6B7280' }}>25th</th>
                                                  <th style={{ padding: '6px', textAlign: 'center', fontSize: '11px', color: '#6B7280' }}>Median</th>
                                                  <th style={{ padding: '6px', textAlign: 'center', fontSize: '11px', color: '#6B7280' }}>75th</th>
                                                  <th style={{ padding: '6px', textAlign: 'center', fontSize: '11px', color: '#6B7280' }}>Count</th>
                                                </tr>
                                              </thead>
                                              <tbody>
                                                {projects.map((p, idx) => (
                                                  <tr
                                                    key={idx}
                                                    style={{
                                                      borderBottom: '1px solid #F3F4F6',
                                                      background: idx % 2 === 0 ? 'white' : '#FAFAFA'
                                                    }}
                                                  >
                                                    <td style={{ padding: '8px', fontWeight: 500 }}>
                                                      <span>{p.project_name}</span>
                                                      {p.sale_type_label && (
                                                        <span
                                                          style={{
                                                            marginLeft: '8px',
                                                            padding: '2px 8px',
                                                            borderRadius: '999px',
                                                            fontSize: '10px',
                                                            fontWeight: 600,
                                                            background:
                                                              p.sale_type_label === 'New Launch'
                                                                ? 'rgba(37, 99, 235, 0.1)'
                                                                : 'rgba(16, 185, 129, 0.1)',
                                                            color:
                                                              p.sale_type_label === 'New Launch'
                                                                ? '#2563EB'
                                                                : '#059669'
                                                          }}
                                                        >
                                                          {p.sale_type_label}
                                                        </span>
                                                      )}
                                                    </td>
                                                    <td style={{ padding: '8px', textAlign: 'center', color: '#6B7280' }}>
                                                      {formatPriceMedian(p.price['25th'])}
                                                    </td>
                                                    <td style={{ padding: '8px', textAlign: 'center', fontWeight: 600 }}>
                                                      {formatPriceMedian(p.price['median'])}
                                                    </td>
                                                    <td
                                                      style={{
                                                        padding: '8px',
                                                        textAlign: 'center',
                                                        color: '#6B7280',
                                                        borderRight: '2px dotted #D1D5DB'
                                                      }}
                                                    >
                                                      {formatPriceMedian(p.price['75th'])}
                                                    </td>
                                                    <td style={{ padding: '8px', textAlign: 'center', color: '#6B7280' }}>
                                                      {formatPSF(p.psf['25th'])}
                                                    </td>
                                                    <td style={{ padding: '8px', textAlign: 'center', fontWeight: 600 }}>
                                                      {formatPSF(p.psf['median'])}
                                                    </td>
                                                    <td style={{ padding: '8px', textAlign: 'center', color: '#6B7280' }}>
                                                      {formatPSF(p.psf['75th'])}
                                                    </td>
                                                    <td style={{ padding: '8px', textAlign: 'center', color: '#4B5563' }}>
                                                      {p.count != null ? p.count.toLocaleString() : '-'}
                                                    </td>
                                                  </tr>
                                                ))}
                                              </tbody>
                                            </table>
                                          </div>
                                        )}
                                      </div>
                                    </td>
                                  </tr>
                                )}
                              </React.Fragment>
                            );
                          });
                        })()}
                      </tbody>
                    </table>
                    <div style={{ marginTop: '8px', fontSize: '11px', color: '#6B7280' }}>
                      * NA indicates insufficient data (&lt;3 transactions in the selected short-term window)
                    </div>
                  </div>
                ) : (
                  <div style={{ textAlign: 'center', padding: '40px', color: '#6B7280' }}>
                    Loading market statistics...
                  </div>
                )}
              </Card>

              {/* Comparable Value Analysis (Buy Box) */}
              <Card title="🎯 Comparable Value Analysis (Buy Box)">
                <div style={{ marginBottom: '16px', padding: '12px', background: '#F9FAFB', borderRadius: '8px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px', flexWrap: 'wrap' }}>
                    <span style={{ fontWeight: 500, color: '#374151' }}>Target Budget:</span>
                    <input
                      type="range"
                      min={BUY_BOX_MIN}
                      max={BUY_BOX_MAX}
                      step={BUY_BOX_STEP}
                      value={buyBoxTargetPrice}
                      onChange={(e) => setBuyBoxTargetPrice(Number(e.target.value))}
                      style={{ flex: 1 }}
                    />
                    <span style={{ fontWeight: 600, color: '#111827' }}>
                      ${ (buyBoxTargetPrice / 1000000).toFixed(2) }M
                    </span>
                  </div>
                  <div style={{ marginTop: '8px', fontSize: '12px', color: '#6B7280' }}>
                    Trade-off Analysis: What you get for ${ (buyBoxTargetPrice / 1000000).toFixed(2) }M (+/- { (PRICE_BAND/1000).toFixed(0) }k)
                  </div>
                </div>

                {buyBoxLoading ? (
                  <div style={{ textAlign: 'center', padding: '40px', color: '#6B7280' }}>
                    <div style={{ fontSize: '16px', marginBottom: '8px' }}>⏳</div>
                    Calculating comparable value...
                  </div>
                ) : (
                  <>
                    <div style={{ display: 'grid', gridTemplateColumns: 'minmax(0,2fr) minmax(0,1.5fr)', gap: '24px', alignItems: 'stretch' }}>
                      {/* Scatter Plot */}
                      <div style={{ minHeight: '320px' }}>
                        <BuyBoxScatter
                          data={buyBoxData.points}
                          targetPrice={buyBoxTargetPrice}
                          priceBand={PRICE_BAND}
                        />
                      </div>

                      {/* Competitor Table */}
                      <div style={{ maxHeight: '360px', overflowY: 'auto', border: '1px solid #E5E7EB', borderRadius: '8px' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '13px' }}>
                          <thead>
                            <tr style={{ background: '#F9FAFB', borderBottom: '1px solid #E5E7EB' }}>
                              <th style={{ padding: '8px', textAlign: 'left' }}>District</th>
                              <th style={{ padding: '8px', textAlign: 'left' }}>Project</th>
                              <th style={{ padding: '8px', textAlign: 'center' }}>Bedrooms</th>
                              <th style={{ padding: '8px', textAlign: 'right' }}>Max Area (sqft)</th>
                              <th style={{ padding: '8px', textAlign: 'right' }}>Price Range ($)</th>
                            </tr>
                          </thead>
                          <tbody>
                            {buyBoxData.competitors.length === 0 ? (
                              <tr>
                                <td colSpan="5" style={{ padding: '16px', textAlign: 'center', color: '#6B7280' }}>
                                  No transactions found in this price band.
                                </td>
                              </tr>
                            ) : (
                              buyBoxData.competitors
                                .slice()
                                .sort((a, b) => (b.max_area_sqft || 0) - (a.max_area_sqft || 0))
                                .map((c, idx) => (
                                  <tr key={idx} style={{ borderBottom: '1px solid #F3F4F6', background: idx % 2 === 0 ? 'white' : '#FAFAFA' }}>
                                    <td style={{ padding: '8px', color: '#4B5563' }}>{c.district}</td>
                                    <td style={{ padding: '8px', fontWeight: 500 }}>{c.project_name}</td>
                                    <td style={{ padding: '8px', textAlign: 'center' }}>
                                      <span
                                        style={{
                                          padding: '2px 8px',
                                          borderRadius: '999px',
                                          fontSize: '11px',
                                          fontWeight: 600,
                                          background:
                                            c.bedroom_count === 2
                                              ? 'rgba(59,130,246,0.1)'
                                              : c.bedroom_count === 3
                                              ? 'rgba(16,185,129,0.1)'
                                              : c.bedroom_count === 4
                                              ? 'rgba(245,158,11,0.1)'
                                              : '#E5E7EB',
                                          color:
                                            c.bedroom_count === 2
                                              ? '#3B82F6'
                                              : c.bedroom_count === 3
                                              ? '#059669'
                                              : c.bedroom_count === 4
                                              ? '#D97706'
                                              : '#4B5563'
                                        }}
                                      >
                                        {c.bedroom_count}B
                                      </span>
                                    </td>
                                    <td style={{ padding: '8px', textAlign: 'right', color: '#4B5563' }}>
                                      {c.max_area_sqft ? Math.round(c.max_area_sqft).toLocaleString() : '-'}
                                    </td>
                                    <td style={{ padding: '8px', textAlign: 'right', fontWeight: 600 }}>
                                      ${Math.round(c.min_price / 1000).toLocaleString()}k - ${Math.round(c.max_price / 1000).toLocaleString()}k
                                    </td>
                                  </tr>
                                ))
                            )}
                          </tbody>
                        </table>
                      </div>
                    </div>

                    {/* Summary */}
                    {buyBoxData.summary && Object.keys(buyBoxData.summary).length > 0 && (
                      <div style={{ marginTop: '12px', fontSize: '13px', color: '#4B5563' }}>
                        In this price range, the smallest unit is <strong>{Math.round(buyBoxData.summary.smallest_area_sqft).toLocaleString()} sqft</strong>
                        {' '}at <strong>{buyBoxData.summary.smallest_project}</strong> ({buyBoxData.summary.smallest_district}), and the largest is
                        {' '}<strong>{Math.round(buyBoxData.summary.largest_area_sqft).toLocaleString()} sqft</strong>
                        {' '}at <strong>{buyBoxData.summary.largest_project}</strong> ({buyBoxData.summary.largest_district}).
                      </div>
                    )}
                  </>
                )}
              </Card>

              {/* Latest Transactions */}
              <Card title={`📝 Latest Transactions (${latestTransactions.length.toLocaleString()} total resale transactions, sorted by date descending)`}>
                <div style={{ overflowX: 'auto' }}>
                  {latestTransactions.length === 0 ? (
                    <div style={{ textAlign: 'center', padding: '40px', color: '#6B7280' }}>No transactions found</div>
                  ) : (
                    <>
                      {latestTransactions.length > 0 && (
                        <div style={{ marginBottom: '16px', padding: '12px', background: '#F3F4F6', borderRadius: '8px', fontSize: '13px', color: '#6B7280' }}>
                          <strong>Date Range:</strong> {
                            (() => {
                              const dates = latestTransactions
                                .map(t => t.transaction_date ? new Date(t.transaction_date) : null)
                                .filter(d => d !== null)
                                .sort((a, b) => a - b);
                              if (dates.length > 0) {
                                const oldest = formatDate(dates[0].toISOString().split('T')[0]);
                                const newest = formatDate(dates[dates.length - 1].toISOString().split('T')[0]);
                                return `${oldest} to ${newest}`;
                              }
                              return 'N/A';
                            })()
                          } • Showing page {currentPage} of {Math.ceil(latestTransactions.length / transactionsPerPage)} ({transactionsPerPage} per page)
                        </div>
                      )}
                    <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '14px' }}>
                      <thead>
                        <tr style={{ borderBottom: '2px solid #E5E7EB' }}>
                          <th style={{ padding: '12px', textAlign: 'left' }}>Project</th>
                          <th style={{ padding: '12px', textAlign: 'left' }}>District</th>
                          <th style={{ padding: '12px', textAlign: 'center' }}>Date</th>
                          <th style={{ padding: '12px', textAlign: 'right' }}>Price</th>
                          <th style={{ padding: '12px', textAlign: 'right' }}>Area (sqft)</th>
                          <th style={{ padding: '12px', textAlign: 'right' }}>PSF</th>
                          <th style={{ padding: '12px', textAlign: 'center' }}>Bedroom</th>
                        </tr>
                      </thead>
                      <tbody>
                        {latestTransactions
                          .slice((currentPage - 1) * transactionsPerPage, currentPage * transactionsPerPage)
                          .map((txn, idx) => (
                          <tr key={idx} style={{ 
                            borderBottom: '1px solid #E5E7EB',
                            background: idx % 2 === 0 ? '#F9FAFB' : 'white'
                          }}>
                            <td style={{ padding: '12px', fontWeight: 500 }}>{txn.project_name}</td>
                            <td style={{ padding: '12px', color: '#6B7280' }}>{txn.district}</td>
                            <td style={{ padding: '12px', textAlign: 'center', color: '#6B7280' }}>
                              {formatDate(txn.transaction_date)}
                            </td>
                            <td style={{ padding: '12px', textAlign: 'right', fontWeight: 600 }}>
                              {formatPrice(txn.price)}
                            </td>
                            <td style={{ padding: '12px', textAlign: 'right', color: '#6B7280' }}>
                              {txn.area_sqft ? Math.round(txn.area_sqft).toLocaleString() : '-'}
                            </td>
                            <td style={{ padding: '12px', textAlign: 'right', color: '#6B7280' }}>
                              {formatPSF(txn.psf)}
                            </td>
                            <td style={{ padding: '12px', textAlign: 'center' }}>
                              <span style={{
                                padding: '4px 10px',
                                borderRadius: '6px',
                                background: (txn.bedroom_type && COLORS[txn.bedroom_type.replace('-Bedroom', 'b')]) ? COLORS[txn.bedroom_type.replace('-Bedroom', 'b')] + '20' : '#E5E7EB',
                                color: (txn.bedroom_type && COLORS[txn.bedroom_type.replace('-Bedroom', 'b')]) ? COLORS[txn.bedroom_type.replace('-Bedroom', 'b')] : '#6B7280',
                                fontWeight: 500,
                                fontSize: '12px'
                              }}>
                                {txn.bedroom_type || 'N/A'}
                              </span>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                    {/* Pagination */}
                    {latestTransactions.length > transactionsPerPage && (
                      <div style={{ 
                        display: 'flex', 
                        justifyContent: 'center', 
                        alignItems: 'center', 
                        gap: '8px', 
                        marginTop: '20px',
                        padding: '16px'
                      }}>
                        <button
                          onClick={() => setCurrentPage(1)}
                          disabled={currentPage === 1}
                          style={{
                            padding: '8px 16px',
                            borderRadius: '6px',
                            border: '1px solid #E5E7EB',
                            background: currentPage === 1 ? '#F3F4F6' : 'white',
                            color: currentPage === 1 ? '#9CA3AF' : '#374151',
                            cursor: currentPage === 1 ? 'not-allowed' : 'pointer',
                            fontWeight: 500
                          }}
                        >
                          First
                        </button>
                        <button
                          onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                          disabled={currentPage === 1}
                          style={{
                            padding: '8px 16px',
                            borderRadius: '6px',
                            border: '1px solid #E5E7EB',
                            background: currentPage === 1 ? '#F3F4F6' : 'white',
                            color: currentPage === 1 ? '#9CA3AF' : '#374151',
                            cursor: currentPage === 1 ? 'not-allowed' : 'pointer',
                            fontWeight: 500
                          }}
                        >
                          Previous
                        </button>
                        <span style={{ color: '#6B7280', fontSize: '14px' }}>
                          Page {currentPage} of {Math.ceil(latestTransactions.length / transactionsPerPage)}
                        </span>
                        <button
                          onClick={() => setCurrentPage(p => Math.min(Math.ceil(latestTransactions.length / transactionsPerPage), p + 1))}
                          disabled={currentPage >= Math.ceil(latestTransactions.length / transactionsPerPage)}
                          style={{
                            padding: '8px 16px',
                            borderRadius: '6px',
                            border: '1px solid #E5E7EB',
                            background: currentPage >= Math.ceil(latestTransactions.length / transactionsPerPage) ? '#F3F4F6' : 'white',
                            color: currentPage >= Math.ceil(latestTransactions.length / transactionsPerPage) ? '#9CA3AF' : '#374151',
                            cursor: currentPage >= Math.ceil(latestTransactions.length / transactionsPerPage) ? 'not-allowed' : 'pointer',
                            fontWeight: 500
                          }}
                        >
                          Next
                        </button>
                        <button
                          onClick={() => setCurrentPage(Math.ceil(latestTransactions.length / transactionsPerPage))}
                          disabled={currentPage >= Math.ceil(latestTransactions.length / transactionsPerPage)}
                          style={{
                            padding: '8px 16px',
                            borderRadius: '6px',
                            border: '1px solid #E5E7EB',
                            background: currentPage >= Math.ceil(latestTransactions.length / transactionsPerPage) ? '#F3F4F6' : 'white',
                            color: currentPage >= Math.ceil(latestTransactions.length / transactionsPerPage) ? '#9CA3AF' : '#374151',
                            cursor: currentPage >= Math.ceil(latestTransactions.length / transactionsPerPage) ? 'not-allowed' : 'pointer',
                            fontWeight: 500
                          }}
                        >
                          Last
                        </button>
                      </div>
                    )}
                    </>
                  )}
                </div>
              </Card>
            </>
          )}

          {/* Footer */}
          <div style={{ 
            textAlign: 'center', 
            color: '#9CA3AF', 
            fontSize: '13px',
            marginTop: '32px',
            paddingTop: '24px',
            borderTop: '1px solid #E5E7EB'
          }}>
            <div style={{ marginBottom: '16px' }}>
              Data Source: URA Data Service
            </div>
            <div style={{ 
              display: 'inline-block',
              marginTop: '16px',
              fontSize: '12px'
            }}>
              <div style={{ 
                marginBottom: '8px', 
                fontWeight: 600, 
                color: '#6B7280' 
              }}>
                Bedroom Classification Calculations (Max Sqft for 2B / 3B / 4B)
              </div>
              <table style={{ 
                margin: '0 auto',
                borderCollapse: 'collapse',
                fontSize: '11px',
                color: '#6B7280'
              }}>
                <thead>
                  <tr>
                    <th style={{ 
                      padding: '6px 12px', 
                      textAlign: 'left', 
                      borderBottom: '1px solid #E5E7EB',
                      fontWeight: 600
                    }}>Category</th>
                    <th style={{ 
                      padding: '6px 12px', 
                      textAlign: 'center', 
                      borderBottom: '1px solid #E5E7EB',
                      fontWeight: 600
                    }}>2B Max</th>
                    <th style={{ 
                      padding: '6px 12px', 
                      textAlign: 'center', 
                      borderBottom: '1px solid #E5E7EB',
                      fontWeight: 600
                    }}>3B Max</th>
                    <th style={{ 
                      padding: '6px 12px', 
                      textAlign: 'center', 
                      borderBottom: '1px solid #E5E7EB',
                      fontWeight: 600
                    }}>4B Max</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style={{ 
                      padding: '6px 12px', 
                      textAlign: 'left',
                      borderBottom: '1px solid #F3F4F6'
                    }}>Pre-Harmonization (New Sale &lt; Jun '23)</td>
                    <td style={{ 
                      padding: '6px 12px', 
                      textAlign: 'center',
                      borderBottom: '1px solid #F3F4F6'
                    }}>850</td>
                    <td style={{ 
                      padding: '6px 12px', 
                      textAlign: 'center',
                      borderBottom: '1px solid #F3F4F6'
                    }}>1,200</td>
                    <td style={{ 
                      padding: '6px 12px', 
                      textAlign: 'center',
                      borderBottom: '1px solid #F3F4F6'
                    }}>&gt;1,200</td>
                  </tr>
                  <tr>
                    <td style={{ 
                      padding: '6px 12px', 
                      textAlign: 'left',
                      borderBottom: '1px solid #F3F4F6'
                    }}>Post-Harmonization (New Sale ≥ Jun '23)</td>
                    <td style={{ 
                      padding: '6px 12px', 
                      textAlign: 'center',
                      borderBottom: '1px solid #F3F4F6'
                    }}>780</td>
                    <td style={{ 
                      padding: '6px 12px', 
                      textAlign: 'center',
                      borderBottom: '1px solid #F3F4F6'
                    }}>1,150</td>
                    <td style={{ 
                      padding: '6px 12px', 
                      textAlign: 'center',
                      borderBottom: '1px solid #F3F4F6'
                    }}>&gt;1,150</td>
                  </tr>
                  <tr>
                    <td style={{ 
                      padding: '6px 12px', 
                      textAlign: 'left'
                    }}>Resale (Legacy)</td>
                    <td style={{ 
                      padding: '6px 12px', 
                      textAlign: 'center'
                    }}>950</td>
                    <td style={{ 
                      padding: '6px 12px', 
                      textAlign: 'center'
                    }}>1,350</td>
                    <td style={{ 
                      padding: '6px 12px', 
                      textAlign: 'center'
                    }}>&gt;1,350</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    }

      // Wait for DOM to be ready and render
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          ReactDOM.render(<Dashboard />, document.getElementById('root'));
        });
      } else {
        ReactDOM.render(<Dashboard />, document.getElementById('root'));
      }
    };
    
    // Start dashboard if all dependencies are loaded
    if (window.chartJSReady && window.reactReady) {
      window.initDashboard();
    }
    
    // Fallback: try to initialize after a short delay
    setTimeout(() => {
      if (typeof React !== 'undefined' && typeof ReactDOM !== 'undefined' && typeof Chart !== 'undefined') {
        if (window.initDashboard) {
          window.initDashboard();
        }
      }
    }, 1000);
  </script>
</body>
</html>
