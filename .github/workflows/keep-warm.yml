# Keep Backend Warm - Prevents Render cold start 502s
#
# Problem: Render free tier spins down after 15 min of inactivity.
# Cold starts cause 30+ second delays → 502 timeouts → auth failures.
#
# Solution: Ping /api/ping every 10 minutes to keep the service warm.
# /api/ping is a zero-dependency endpoint (no DB, no Firebase).

name: Keep Backend Warm

on:
  schedule:
    # Every 10 minutes (Render spins down after ~15 min idle)
    - cron: '*/10 * * * *'
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - name: Ping backend to keep warm
        run: |
          echo "Pinging backend at $(date -u)"

          # Retry loop - helps if Render is very cold
          for i in 1 2; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 30 \
              -H "User-Agent: keep-warm-github-action" \
              "https://sg-property-analyzer.onrender.com/api/ping")

            echo "Attempt $i → $RESPONSE"

            [ "$RESPONSE" = "200" ] && break
            sleep 5
          done

          if [ "$RESPONSE" = "200" ]; then
            echo "Backend is warm and healthy"
          else
            echo "Warning: Backend returned $RESPONSE after retries"
            # Don't fail the job - the ping itself helps wake it up
          fi
