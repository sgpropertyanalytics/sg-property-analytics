name: Migration Integrity Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  migration-check:
    name: Migration Integrity Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Run migration integrity validator
        id: audit
        run: |
          python scripts/migration-audit.py --output json --ci --save migration-report.json
        continue-on-error: true

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: migration-integrity-report
          path: migration-report.json
          retention-days: 30

      - name: Generate summary
        if: always()
        run: |
          echo "## Migration Integrity Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f migration-report.json ]; then
            STATUS=$(jq -r '.summary.status' migration-report.json)
            P0=$(jq -r '.summary.p0Count' migration-report.json)
            P1=$(jq -r '.summary.p1Count' migration-report.json)
            P2=$(jq -r '.summary.p2Count' migration-report.json)
            ALLOWLISTED=$(jq -r '.summary.allowlistedCount' migration-report.json)

            if [ "$STATUS" = "CRITICAL" ]; then
              echo "### :x: Status: CRITICAL" >> $GITHUB_STEP_SUMMARY
            elif [ "$STATUS" = "INCOMPLETE" ]; then
              echo "### :warning: Status: INCOMPLETE" >> $GITHUB_STEP_SUMMARY
            else
              echo "### :white_check_mark: Status: COMPLETE" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| P0 Issues (blocking) | $P0 |" >> $GITHUB_STEP_SUMMARY
            echo "| P1 Issues (warning) | $P1 |" >> $GITHUB_STEP_SUMMARY
            echo "| P2 Issues (info) | $P2 |" >> $GITHUB_STEP_SUMMARY
            echo "| Allowlisted | $ALLOWLISTED |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # List P0 findings
            if [ "$P0" -gt 0 ]; then
              echo "### P0 Issues (Must Fix)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              jq -r '.checks[] | select(.status == "FAIL" and .severity == "P0") | "- **\(.name)**: \(.findings[0].message // "Issue found")"' migration-report.json >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # List P1 findings
            if [ "$P1" -gt 0 ]; then
              echo "### P1 Issues (Should Fix)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              jq -r '.checks[] | select(.status == "FAIL" and .severity == "P1") | "- **\(.name)**: \(.findings[0].message // "Issue found")"' migration-report.json >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### :x: Report generation failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let report;
            try {
              report = JSON.parse(fs.readFileSync('migration-report.json', 'utf8'));
            } catch (e) {
              console.log('Could not read report file');
              return;
            }

            const { summary } = report;
            const statusEmoji = {
              'CRITICAL': ':x:',
              'INCOMPLETE': ':warning:',
              'COMPLETE': ':white_check_mark:'
            }[summary.status] || ':question:';

            let body = `## ${statusEmoji} Migration Integrity Check\n\n`;
            body += `| Metric | Count |\n`;
            body += `|--------|-------|\n`;
            body += `| P0 Issues | ${summary.p0Count} |\n`;
            body += `| P1 Issues | ${summary.p1Count} |\n`;
            body += `| P2 Issues | ${summary.p2Count} |\n`;
            body += `| Allowlisted | ${summary.allowlistedCount} |\n\n`;

            if (summary.p0Count > 0) {
              body += `### :rotating_light: P0 Issues Must Be Fixed\n\n`;
              for (const check of report.checks) {
                if (check.status === 'FAIL' && check.severity === 'P0') {
                  body += `- **${check.name}**\n`;
                  for (const finding of check.findings) {
                    body += `  - ${finding.message}\n`;
                    body += `  - Fix: ${finding.fix}\n`;
                  }
                }
              }
              body += `\n`;
            }

            if (summary.p1Count > 0) {
              body += `<details>\n<summary>P1 Issues (${summary.p1Count})</summary>\n\n`;
              for (const check of report.checks) {
                if (check.status === 'FAIL' && check.severity === 'P1') {
                  body += `- **${check.name}**: ${check.findings[0]?.message || 'Issue found'}\n`;
                }
              }
              body += `\n</details>\n`;
            }

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('Migration Integrity Check')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Check for P0 violations
        if: always()
        run: |
          if [ -f migration-report.json ]; then
            P0=$(jq -r '.summary.p0Count' migration-report.json)
            if [ "$P0" -gt 0 ]; then
              echo "::error::P0 migration integrity violations found. See report for details."
              exit 1
            fi
          fi
