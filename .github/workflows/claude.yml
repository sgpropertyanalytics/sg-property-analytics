name: Claude Code

on:
  pull_request:
    types: [opened, synchronize, labeled]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  issues:
    types: [opened, assigned]
  workflow_run:
    workflows: ["Regression Suite"]
    types: [completed]

jobs:
  # =============================================================================
  # STAGE 0: Fast Triage (<2 min, always runs on PR)
  # Goal: Quick risk signal for reviewers
  # =============================================================================
  fast-triage:
    name: "Stage 0: Fast Triage"
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Fast Triage
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            # Stage 0: Fast Triage

            Analyze this PR quickly (<2 min). Be diff-aware: only analyze changed files + nearby dependents.

            ---

            ## 1. Risk Score

            Assign: **üü¢ Low** / **üü° Medium** / **üî¥ High**

            Risk factors (check which apply):
            - [ ] Touches auth (AuthContext, login, tokens)
            - [ ] Touches hooks/ or custom React hooks
            - [ ] Touches api/client or adapters
            - [ ] Touches contract schemas or generated types
            - [ ] Touches SQL queries or services/
            - [ ] Touches powerbi/ or dashboard components
            - [ ] Changes shared utilities used by 3+ files
            - [ ] PR size > 300 LOC
            - [ ] Modifies or removes existing tests

            Score:
            - üü¢ Low: 0-1 factors
            - üü° Medium: 2-3 factors
            - üî¥ High: 4+ factors OR touches auth/contracts

            ---

            ## 2. Top 5 Findings

            List the 5 most important observations (or fewer if clean):

            | # | File:Line | Finding | Why It Matters |
            |---|-----------|---------|----------------|
            | 1 | | | |
            | 2 | | | |
            | 3 | | | |
            | 4 | | | |
            | 5 | | | |

            ---

            ## 3. Required Reviewers

            Tag who needs to review based on touched areas:

            - [ ] **Backend owner** ‚Äî if routes/, services/, SQL changed
            - [ ] **Auth owner** ‚Äî if auth, tokens, login touched
            - [ ] **Frontend owner** ‚Äî if components/, pages/ changed
            - [ ] **Data owner** ‚Äî if CSV, data processing changed

            ---

            ## 4. Suggested Tests

            Based on changed files, recommend which test suites matter:

            | Test Suite | Run? | Why |
            |------------|------|-----|
            | `npm run lint` | | |
            | `npm run typecheck` | | |
            | `npm run test:ci` | | |
            | `npm run test:e2e` | | |
            | `pytest tests/test_*.py` | | |

            ---

            ## 5. Quick Verdict

            **Triage Result:** LOOKS GOOD / NEEDS ATTENTION / NEEDS DEEP REVIEW

            If NEEDS DEEP REVIEW, explain why in one sentence.

  # =============================================================================
  # STAGE 1: Deep Review (gated by risk, file patterns, or label)
  # Goal: Comprehensive analysis when it matters
  # =============================================================================
  deep-review:
    name: "Stage 1: Deep Review"
    if: |
      github.event_name == 'pull_request' && (
        contains(github.event.pull_request.labels.*.name, 'risk:high') ||
        contains(github.event.pull_request.labels.*.name, 'needs-deep-review')
      )
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Deep Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            # Stage 1: Deep Review

            This PR was flagged for deep review. Perform comprehensive analysis.

            ---

            ## 1. Architecture & Migration Consistency

            - [ ] No deprecated patterns reintroduced
            - [ ] No duplicate hook patterns (old useQuery vs React Query)
            - [ ] No legacy endpoint usage (/districts instead of /filter-options)
            - [ ] Migration is complete (no mixed old/new patterns)

            **Findings:**

            ---

            ## 2. Stale/Race Safety Checklist

            For each async operation in changed files:

            | File | Hook/Function | Abort Signal? | Stale Guard? | Cleanup? |
            |------|---------------|---------------|--------------|----------|
            | | | | | |

            - [ ] All API calls use abort signal
            - [ ] No setState after unmount possible
            - [ ] React Query OR useStaleRequestGuard used
            - [ ] useEffect cleanup functions present

            **Findings:**

            ---

            ## 3. Contract Semantics

            Beyond schema drift, check semantic correctness:

            - [ ] Response field meanings unchanged (not just names)
            - [ ] Null handling consistent (backend sends null vs undefined)
            - [ ] Array vs single value semantics preserved
            - [ ] Date format expectations match (ISO string vs Date object)
            - [ ] Enum values match between frontend/backend

            **Findings:**

            ---

            ## 4. Provider & Context Tree

            - [ ] All hooks used within required Providers
            - [ ] No orphaned Context consumers
            - [ ] Provider hierarchy correct (Auth > Subscription > Filters)

            **Findings:**

            ---

            ## 5. SQL & Data Safety

            - [ ] Uses `:param` bindings (not f-strings)
            - [ ] Includes `COALESCE(is_outlier, false) = false`
            - [ ] Date bounds exclusive upper bound
            - [ ] NULL guards for optional params
            - [ ] No N+1 query patterns

            **Findings:**

            ---

            ## 6. Breaking Change Analysis

            ```
            Changed Files:
            [list files]

            Downstream Dependents:
            [list files that import/use changed code]

            Breaking Risk:
            [assessment]
            ```

            ---

            ## Go/No-Go Recommendation

            **üö¶ VERDICT:** GO / NO-GO / CONDITIONAL

            If NO-GO or CONDITIONAL, list required fixes:
            1.
            2.
            3.

  # =============================================================================
  # STAGE 1b: Deep Review (triggered by @claude deep-review comment)
  # =============================================================================
  deep-review-on-demand:
    name: "Stage 1: Deep Review (on-demand)"
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude deep-review')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude deep-review'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Deep Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            # Stage 1: Deep Review (Requested)

            User requested deep review. Perform comprehensive analysis.

            ## 1. Architecture & Migration Consistency
            - No deprecated patterns, no duplicate hooks, no legacy endpoints
            - Check migration completeness

            ## 2. Stale/Race Safety
            - Abort signals, stale guards, cleanup functions
            - No setState after unmount

            ## 3. Contract Semantics
            - Response field meanings, null handling, enum values

            ## 4. Provider & Context Tree
            - Hooks within Providers, no orphaned consumers

            ## 5. SQL & Data Safety
            - :param bindings, outlier exclusion, NULL guards

            ## 6. Breaking Changes
            - Trace downstream dependents

            ---

            **üö¶ VERDICT:** GO / NO-GO / CONDITIONAL

            List any required fixes.

  # =============================================================================
  # STAGE 2: CI Summary (after Regression Suite completes)
  # Goal: Human-readable summary of CI results
  # =============================================================================
  ci-summary:
    name: "Stage 2: CI Summary"
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion != 'skipped'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });
            const prs = run.data.pull_requests;
            if (prs && prs.length > 0) {
              return prs[0].number;
            }
            return null;

      - name: Get CI job results
        id: ci-results
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            const summary = jobs.data.jobs.map(job => ({
              name: job.name,
              status: job.conclusion || job.status,
              duration: job.completed_at && job.started_at
                ? Math.round((new Date(job.completed_at) - new Date(job.started_at)) / 1000)
                : null
            }));

            return JSON.stringify(summary);

      - name: Claude CI Summary
        if: steps.pr.outputs.result != 'null'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            # Stage 2: CI Summary

            The Regression Suite just completed. Summarize results for the team.

            ## CI Job Results

            ```json
            ${{ steps.ci-results.outputs.result }}
            ```

            Overall workflow conclusion: **${{ github.event.workflow_run.conclusion }}**

            ---

            ## Your Task

            ### 1. Jobs Summary

            | Job | Status | Duration | Purpose |
            |-----|--------|----------|---------|
            | (parse from JSON above) | | | (explain what each job checks) |

            Map each job to what it validates:
            - `contract-guard` ‚Üí Frontend/backend contracts in sync
            - `frontend-import-guard` ‚Üí No broken imports or deprecated endpoints
            - `sql-safety` ‚Üí SQL injection protection, proper bindings
            - `data-guard` ‚Üí CSV data integrity
            - `route-contract` ‚Üí All frontend routes exist in backend
            - `smoke-tests` ‚Üí API endpoints respond
            - `unit-tests` ‚Üí Backend logic correct
            - `integration-tests` ‚Üí Regression snapshots, API invariants
            - `frontend-tests` ‚Üí Lint, typecheck, unit tests, build
            - `frontend-e2e` ‚Üí Runtime smoke tests
            - `security-audit` ‚Üí Dependency vulnerabilities

            ### 2. Failures Analysis

            If any jobs failed:

            | Failed Job | Likely Root Cause | Suggested Fix |
            |------------|-------------------|---------------|
            | | | |

            ### 3. Fix Order

            If multiple failures, suggest order to fix (avoid whack-a-mole):

            1. Fix X first because...
            2. Then fix Y because...
            3. Finally fix Z...

            ### 4. Overall Verdict

            **CI Result:** ‚úÖ ALL PASSED / ‚ö†Ô∏è WARNINGS / ‚ùå FAILED

            **Ready to Merge:** YES / NO / AFTER FIXES

  # =============================================================================
  # Q&A: Respond to general @claude questions
  # =============================================================================
  claude-qa:
    name: "Claude Q&A"
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude') && !contains(github.event.comment.body, '@claude deep-review')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude') && !contains(github.event.comment.body, '@claude deep-review')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action == 'opened' && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action == 'assigned' && github.event.assignee.login == 'claude[bot]')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Claude Q&A
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # Answers the user's specific question using CLAUDE.md context
