name: Claude Code

on:
  # CI Summary: triggers after Regression Suite completes
  workflow_run:
    workflows: ["Regression Suite"]
    types: [completed]
  # Q&A: triggers on @claude mentions
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  # Auto PR Summary: triggers on PR opened/updated
  pull_request:
    types: [opened, synchronize]

jobs:
  # =============================================================================
  # CI Summary (after Regression Suite completes)
  # Goal: Human-readable summary of CI results
  # =============================================================================
  ci-summary:
    name: "CI Summary"
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion != 'skipped'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      actions: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });
            const prs = run.data.pull_requests;
            if (prs && prs.length > 0) {
              return prs[0].number;
            }
            return null;

      - name: Get CI job results
        id: ci-results
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            const summary = jobs.data.jobs.map(job => ({
              name: job.name,
              status: job.conclusion || job.status,
              duration: job.completed_at && job.started_at
                ? Math.round((new Date(job.completed_at) - new Date(job.started_at)) / 1000)
                : null
            }));

            return JSON.stringify(summary);

      - name: Get failure details
        id: failure-logs
        if: github.event.workflow_run.conclusion == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            // Get failed jobs with their failed steps
            const failedJobs = jobs.data.jobs
              .filter(j => j.conclusion === 'failure')
              .slice(0, 3)  // Limit to 3 jobs to avoid token overflow
              .map(job => ({
                name: job.name,
                failed_steps: job.steps
                  .filter(s => s.conclusion === 'failure')
                  .map(s => s.name)
              }));

            return JSON.stringify(failedJobs, null, 2);

      - name: Claude CI Summary
        if: steps.pr.outputs.result != 'null'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: "--model claude-3-5-haiku-20241022"
          direct_prompt: true
          prompt: |
            # CI Summary

            The Regression Suite just completed. Summarize results for the team.

            ## CI Job Results

            ```json
            ${{ steps.ci-results.outputs.result }}
            ```

            Overall workflow conclusion: **${{ github.event.workflow_run.conclusion }}**

            ## Failed Jobs Detail (if any)

            ```json
            ${{ steps.failure-logs.outputs.result }}
            ```

            Use the failed steps to diagnose root causes. Common patterns:
            - `contract-guard` + "drift detected" ‚Üí Run `python backend/scripts/generate_contracts.py`
            - `frontend-tests` + "lint" ‚Üí Run `npm run lint:ci` locally
            - `frontend-e2e` + timeout ‚Üí Check for missing mocks or slow renders
            - `integration-tests` + "snapshot" ‚Üí Intentional data change? Run `--update-snapshots`

            ---

            ## Your Task

            ### 1. Jobs Summary

            | Job | Status | Duration | Purpose |
            |-----|--------|----------|---------|
            | (parse from JSON above) | | | (explain what each job checks) |

            Map each job to what it validates:
            - `contract-guard` ‚Üí Frontend/backend contracts in sync
            - `frontend-import-guard` ‚Üí No broken imports or deprecated endpoints
            - `sql-safety` ‚Üí SQL injection protection, proper bindings
            - `data-guard` ‚Üí CSV data integrity
            - `route-contract` ‚Üí All frontend routes exist in backend
            - `smoke-tests` ‚Üí API endpoints respond
            - `unit-tests` ‚Üí Backend logic correct
            - `integration-tests` ‚Üí Regression snapshots, API invariants
            - `frontend-tests` ‚Üí Lint, typecheck, unit tests, build
            - `frontend-e2e` ‚Üí Runtime smoke tests
            - `security-audit` ‚Üí Dependency vulnerabilities

            ### 2. Failures Analysis

            If any jobs failed:

            | Failed Job | Likely Root Cause | Suggested Fix |
            |------------|-------------------|---------------|
            | | | |

            ### 3. Fix Order

            If multiple failures, suggest order to fix (avoid whack-a-mole):

            1. Fix X first because...
            2. Then fix Y because...
            3. Finally fix Z...

            ### 4. Overall Verdict

            **CI Result:** ‚úÖ ALL PASSED / ‚ö†Ô∏è WARNINGS / ‚ùå FAILED

            **Ready to Merge:** YES / NO / AFTER FIXES

  # =============================================================================
  # PR Summary: Auto-summarize every PR with risk classification
  # =============================================================================
  pr-summary:
    name: "PR Summary"
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff and files
        id: pr-context
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"

          # Get list of changed files
          gh pr view "$PR_NUM" --json files --jq '.files[].path' > /tmp/files.txt

          # Get PR diff (limit to 50KB for auto-summary)
          gh pr diff "$PR_NUM" > /tmp/full_diff.txt
          head -c 50000 /tmp/full_diff.txt > /tmp/diff.txt

          echo "files<<EOFFILES" >> $GITHUB_OUTPUT
          cat /tmp/files.txt >> $GITHUB_OUTPUT
          echo "EOFFILES" >> $GITHUB_OUTPUT

          echo "diff<<EOFDIFF" >> $GITHUB_OUTPUT
          cat /tmp/diff.txt >> $GITHUB_OUTPUT
          echo "EOFDIFF" >> $GITHUB_OUTPUT

      - name: Auto PR Summary
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: "--model claude-3-5-haiku-20241022"
          prompt: |
            # Auto PR Summary

            PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}

            ## Files Changed
            ```
            ${{ steps.pr-context.outputs.files }}
            ```

            ## Diff (first 50KB)
            ```diff
            ${{ steps.pr-context.outputs.diff }}
            ```

            ---

            Provide a BRIEF summary (keep it concise):

            ## üìã Commit Summary
            - [One line per logical change]

            ## üö¶ Risk Level
            Based on `.claude/review-rules.yml`:
            - üî¥ CRITICAL: backend/api/contracts/, backend/services/, backend/routes/, AuthContext
            - üü† HIGH: hooks/, adapters/, schemas/, normalize.py
            - üü° MEDIUM: components/powerbi/, pages/, tests/
            - üü¢ LOW: All other

            **Risk: [LEVEL] - [Brief reason]**

            ## üëÄ Suggested Reviewers
            [Based on files changed, suggest from: needs-backend-owner, needs-auth-owner, needs-contract-review, needs-chart-review]

  # =============================================================================
  # Claude Review: Single job for all @claude mentions on PRs/Issues
  # =============================================================================
  claude-review:
    name: "Claude Review"
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      actions: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR number
        id: pr-number
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=" >> $GITHUB_OUTPUT
          fi

      - name: Get PR diff and files
        id: pr-context
        if: steps.pr-number.outputs.number != ''
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUM="${{ steps.pr-number.outputs.number }}"

          # Get list of changed files
          echo "Getting changed files..."
          gh pr view "$PR_NUM" --json files --jq '.files[].path' > /tmp/files.txt

          # Get PR diff (limit to 100KB to avoid token overflow)
          echo "Getting PR diff..."
          gh pr diff "$PR_NUM" > /tmp/full_diff.txt
          head -c 100000 /tmp/full_diff.txt > /tmp/diff.txt

          # Get PR title and body
          echo "Getting PR metadata..."
          gh pr view "$PR_NUM" --json title,body --jq '"Title: \(.title)\n\nDescription: \(.body // \"No description\")"' > /tmp/pr_meta.txt

          # Output using delimiter to handle multiline
          echo "files<<EOFFILES" >> $GITHUB_OUTPUT
          cat /tmp/files.txt >> $GITHUB_OUTPUT
          echo "EOFFILES" >> $GITHUB_OUTPUT

          echo "diff<<EOFDIFF" >> $GITHUB_OUTPUT
          cat /tmp/diff.txt >> $GITHUB_OUTPUT
          echo "EOFDIFF" >> $GITHUB_OUTPUT

          echo "meta<<EOFMETA" >> $GITHUB_OUTPUT
          cat /tmp/pr_meta.txt >> $GITHUB_OUTPUT
          echo "EOFMETA" >> $GITHUB_OUTPUT

          # Check if diff was truncated
          FULL_SIZE=$(wc -c < /tmp/full_diff.txt)
          if [ "$FULL_SIZE" -gt 100000 ]; then
            echo "truncated=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Diff truncated from ${FULL_SIZE} bytes to 100KB"
          else
            echo "truncated=false" >> $GITHUB_OUTPUT
          fi

          # Mark as successful
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Claude Review
        if: steps.pr-number.outputs.number != '' && steps.pr-context.outputs.success == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: "--model claude-3-5-haiku-20241022"
          prompt: |
            # Code Review

            You are reviewing PR #${{ steps.pr-number.outputs.number }}.

            ## PR Information
            ${{ steps.pr-context.outputs.meta }}

            ## Files Changed
            ```
            ${{ steps.pr-context.outputs.files }}
            ```

            ## Code Diff
            ${{ steps.pr-context.outputs.truncated == 'true' && '‚ö†Ô∏è **Note: Diff truncated to 100KB**' || '' }}
            ```diff
            ${{ steps.pr-context.outputs.diff }}
            ```

            ## User Comment
            ${{ github.event.comment.body }}

            ---

            Read CLAUDE.md and .claude/review-rules.yml for codebase standards.

            **First**, answer any specific questions the user asked in their comment.

            **Then**, provide the full review starting with these sections:

            ---

            ## üìã Commit Summary

            Summarize all commits in this PR in a concise bullet list:
            - What changed (1-2 sentences per commit)
            - Group related commits if applicable

            ---

            ## üö¶ Risk Assessment

            Based on files changed, auto-classify risk using `.claude/review-rules.yml` risk_directories:

            | Risk Level | Paths |
            |------------|-------|
            | üî¥ CRITICAL | `backend/api/contracts/`, `backend/services/`, `frontend/src/context/AuthContext`, `backend/routes/` |
            | üü† HIGH | `frontend/src/hooks/`, `frontend/src/adapters/`, `frontend/src/schemas/`, `backend/utils/normalize.py` |
            | üü° MEDIUM | `frontend/src/components/powerbi/`, `frontend/src/pages/`, `backend/tests/` |
            | üü¢ LOW | All other paths |

            **Determine the highest risk level based on files touched.**

            Output format:
            ```
            **Risk Level:** üî¥ CRITICAL / üü† HIGH / üü° MEDIUM / üü¢ LOW

            **Reason:** [Which critical/high/medium paths were touched]

            **Suggested Reviewers:** [Based on human_review_tags in review-rules.yml]
            ```

            ---

            ## Architecture Review

            ## 6-Point Quality Checklist

            ### 1. Framework Alignment
            **Question:** Is this aligned with the codebase's architectural patterns?

            Check against:
            - Layer responsibilities: Pages decide ‚Üí Components render ‚Üí Utils transform ‚Üí Backend enforces
            - Single source of truth: SaleType enum, constants.py, contract_schema.py
            - Reference implementations: TimeTrendChart.jsx, analytics.py, dashboard_service.py

            **Verdict:** ‚úÖ ALIGNED / ‚ö†Ô∏è PARTIAL / ‚ùå VIOLATES

            ### 2. Code Efficiency
            **Question:** Is this clean, efficient code?

            Check for:
            - Minimal code to achieve the goal
            - No unnecessary abstractions
            - Clear data flow
            - Appropriate use of existing utilities

            **Verdict:** ‚úÖ CLEAN / ‚ö†Ô∏è COULD SIMPLIFY / ‚ùå NEEDS REFACTOR

            ### 3. Over-Engineering Detection
            **Question:** Are there redundant complexity layers?

            Red flags:
            - New abstractions for single-use cases
            - Premature optimization
            - Feature flags for simple changes
            - Custom infrastructure when libraries exist (React Query, Zustand)
            - >50 lines of custom hooks

            **Verdict:** ‚úÖ APPROPRIATE / ‚ö†Ô∏è BORDERLINE / ‚ùå OVER-ENGINEERED

            ### 4. Band-Aid Detection
            **Question:** Is this a band-aid fix or root cause fix?

            Red flags:
            - `if (specificEdgeCase)` hacks
            - Hardcoded values instead of constants
            - `// TODO: fix later` comments
            - Duplicating code "to be safe"
            - Workarounds instead of root cause fixes

            **Verdict:** ‚úÖ ROOT CAUSE FIX / ‚ö†Ô∏è ACCEPTABLE WORKAROUND / ‚ùå BAND-AID

            ### 5. Production-Grade Assessment
            **Question:** Is this robust and regression-proof?

            Check for:
            - Works at 10x scale
            - Handles edge cases gracefully
            - Has appropriate error handling
            - Includes necessary tests
            - Matches how similar problems are solved in codebase

            **Verdict:** ‚úÖ PRODUCTION-GRADE / ‚ö†Ô∏è NEEDS HARDENING / ‚ùå NOT READY

            ### 6. Canonical Standards
            **Question:** Does this follow centralized patterns?

            Check for:
            - Uses existing constants (REGIONS, BEDROOM_ORDER, SaleType)
            - Uses centralized API client (api/client.js)
            - Uses existing adapters pattern
            - SQL in services, not routes
            - :param bindings, not f-strings

            **Verdict:** ‚úÖ CANONICAL / ‚ö†Ô∏è MINOR DEVIATIONS / ‚ùå NON-STANDARD

            ---

            ## Quick Compliance Checks (auto-fail if violated)

            | Check | ‚úÖ/‚ùå | Details |
            |-------|------|---------|
            | Layer responsibilities | | Pages decide logic, Components only render props |
            | No new abstractions | | Uses existing patterns, no reinventing |
            | SQL param bindings | | Uses `:param` style, never f-strings |
            | Outlier exclusion | | Queries include `COALESCE(is_outlier, false) = false` |
            | Chart state handling | | Handles loading/error/empty/success states |

            ---

            ## Summary

            | Criterion | Verdict | Notes |
            |-----------|---------|-------|
            | 1. Framework Alignment | | |
            | 2. Code Efficiency | | |
            | 3. Over-Engineering | | |
            | 4. Band-Aid Detection | | |
            | 5. Production-Grade | | |
            | 6. Canonical Standards | | |

            **Score:** X/6 passing

            **Recommendation:** ‚úÖ APPROVE / ‚ö†Ô∏è APPROVE WITH COMMENTS / üîÑ REQUEST CHANGES / ‚ùå BLOCK

            ## Specific Issues

            List specific files and line numbers that need attention.

            ## Suggested Improvements

            Concrete suggestions to improve the PR.
