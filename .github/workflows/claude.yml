name: Claude Code

on:
  pull_request:
    types: [opened, synchronize, labeled]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  issues:
    types: [opened, assigned]
  workflow_run:
    workflows: ["Regression Suite"]
    types: [completed]

jobs:
  # =============================================================================
  # STAGE 0: Fast Triage (<2 min, always runs on PR)
  # Goal: Quick risk signal for reviewers
  # =============================================================================
  fast-triage:
    name: "Stage 0: Fast Triage"
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Map change impact
        id: impact
        run: |
          # Get changed files
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null || git diff --name-only HEAD~1)
          echo "Changed files:"
          echo "$CHANGED"

          # Run impact mapping if script exists
          if [ -f "scripts/map_change_impact.py" ]; then
            echo "$CHANGED" | python scripts/map_change_impact.py > /tmp/impact.json 2>/dev/null || true
            if [ -f "/tmp/impact.json" ]; then
              echo "impact<<EOF" >> $GITHUB_OUTPUT
              cat /tmp/impact.json >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
          fi

          # Quick risk assessment based on paths
          if echo "$CHANGED" | grep -q "backend/services/\|backend/api/contracts/"; then
            echo "risk=HIGH - Backend service/contract changes affect multiple charts" >> $GITHUB_OUTPUT
          elif echo "$CHANGED" | grep -q "frontend/src/context/Auth\|backend/routes/auth"; then
            echo "risk=HIGH - Auth changes require careful review" >> $GITHUB_OUTPUT
          elif echo "$CHANGED" | grep -q "frontend/src/adapters/\|frontend/src/hooks/"; then
            echo "risk=MEDIUM - Adapter/hook changes affect data flow" >> $GITHUB_OUTPUT
          elif echo "$CHANGED" | grep -q "frontend/src/components/powerbi/"; then
            echo "risk=MEDIUM - Chart component changes" >> $GITHUB_OUTPUT
          else
            echo "risk=LOW - Standard changes" >> $GITHUB_OUTPUT
          fi

      - name: Claude Fast Triage
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-3-5-haiku-20241022
          prompt: |
            # Stage 0: Fast Triage + Stability Review

            Analyze this PR quickly. Be diff-aware: only analyze changed files + nearby dependents.

            ## Pre-computed Impact Analysis

            **Auto-detected risk:** ${{ steps.impact.outputs.risk }}

            **Impact details (if available):**
            ```json
            ${{ steps.impact.outputs.impact }}
            ```

            Use this impact analysis to focus your review. If impact shows affected charts/pages, verify those areas specifically.

            ---

            ## 1. Risk Score

            Assign: **üü¢ Low** / **üü° Medium** / **üî¥ High**

            Risk factors (check which apply):
            - [ ] Touches auth (AuthContext, login, tokens)
            - [ ] Touches hooks/ or custom React hooks
            - [ ] Touches api/client or adapters
            - [ ] Touches contract schemas or generated types
            - [ ] Touches SQL queries or services/
            - [ ] Touches powerbi/ or dashboard components
            - [ ] Changes shared utilities used by 3+ files
            - [ ] PR size > 300 LOC
            - [ ] Modifies or removes existing tests

            Score:
            - üü¢ Low: 0-1 factors
            - üü° Medium: 2-3 factors
            - üî¥ High: 4+ factors OR touches auth/contracts

            ---

            ## 2. Stability Checklist (10-Point)

            Review each category. Report: ‚úÖ (no issues) / ‚ö†Ô∏è (minor) / ‚ùå (blocking with file:line)

            ### 2.1 Correctness / Logic
            - Does the code actually do what the PR claims?
            - Edge cases handled?
            - Any silent behavior changes?

            ### 2.2 Side Effects & Regressions
            - Does this break existing flows?
            - Any shared logic touched?
            - Any unintended behavior change?

            ### 2.3 State & Lifecycle Safety
            - React: hooks order, dependency arrays, stale closures
            - Backend: async flow, race conditions, retries, idempotency
            - No updates after unmount / stale requests

            ### 2.4 Error Handling & Fallbacks
            - Are errors handled or swallowed silently?
            - Meaningful user-facing errors?
            - Safe fallback states?
            - Red flags: empty catch {}, console.log instead of error handling

            ### 2.5 Performance / Overfetching
            - Unnecessary re-renders?
            - Repeated API calls?
            - Heavy computation inside render?
            - Missing memoization?

            ### 2.6 API / Contract Consistency
            - Does frontend match backend contract?
            - Any implicit assumptions?
            - Breaking changes without versioning?
            - Does any route use request.args.get() instead of g.normalized_params?

            ### 2.7 Code Simplicity & Readability
            - Is this over-engineered?
            - Can this be simpler?
            - Is intent obvious without comments?

            ### 2.8 Naming & Structure
            - Clear variable and function names?
            - Files in the right layer? (Pages decide, Components render)
            - No "temporary" naming left behind?

            ### 2.9 Security / Data Safety
            - Auth checks present?
            - Sensitive data exposed?
            - Token / credential handling correct?
            - No client-side trust assumptions?

            ### 2.10 Cleanup & Technical Debt
            - Dead code?
            - Debug logs left in?
            - TODOs without tickets?
            - Duplicate logic?

            **Checklist Summary:**
            ```
            1. Correctness:    [‚úÖ/‚ö†Ô∏è/‚ùå]
            2. Side Effects:   [‚úÖ/‚ö†Ô∏è/‚ùå]
            3. State Safety:   [‚úÖ/‚ö†Ô∏è/‚ùå]
            4. Error Handling: [‚úÖ/‚ö†Ô∏è/‚ùå]
            5. Performance:    [‚úÖ/‚ö†Ô∏è/‚ùå]
            6. API Contract:   [‚úÖ/‚ö†Ô∏è/‚ùå]
            7. Simplicity:     [‚úÖ/‚ö†Ô∏è/‚ùå]
            8. Naming:         [‚úÖ/‚ö†Ô∏è/‚ùå]
            9. Security:       [‚úÖ/‚ö†Ô∏è/‚ùå]
            10. Cleanup:       [‚úÖ/‚ö†Ô∏è/‚ùå]
            ```

            ---

            ## 3. Top 5 Findings

            List the 5 most important issues found (or fewer if clean):

            | # | File:Line | Finding | Severity |
            |---|-----------|---------|----------|
            | 1 | | | |
            | 2 | | | |
            | 3 | | | |
            | 4 | | | |
            | 5 | | | |

            ---

            ## 4. Required Reviewers

            Tag who needs to review based on touched areas:

            - [ ] **Backend owner** ‚Äî if routes/, services/, SQL changed
            - [ ] **Auth owner** ‚Äî if auth, tokens, login touched
            - [ ] **Frontend owner** ‚Äî if components/, pages/ changed
            - [ ] **Data owner** ‚Äî if CSV, data processing changed

            ---

            ## 5. Suggested Tests

            Based on changed files, recommend which test suites matter:

            | Test Suite | Run? | Why |
            |------------|------|-----|
            | `npm run lint` | | |
            | `npm run typecheck` | | |
            | `npm run test:ci` | | |
            | `npm run test:e2e` | | |
            | `pytest tests/test_*.py` | | |

            ---

            ## 6. Verdict

            **Recommendation:** APPROVE / REQUEST CHANGES / NEEDS DISCUSSION

            If REQUEST CHANGES or NEEDS DISCUSSION, list the blocking issues.

            ---

            DO NOT suggest:
            - Library replacements (Pydantic, Zustand, etc.) - architecture is settled
            - Refactoring unrelated code
            - Style/formatting preferences

  # =============================================================================
  # STAGE 1: Deep Review (gated by risk, file patterns, or label)
  # Goal: Comprehensive analysis when it matters
  # =============================================================================
  deep-review:
    name: "Stage 1: Deep Review"
    if: |
      github.event_name == 'pull_request' && (
        contains(github.event.pull_request.labels.*.name, 'risk:high') ||
        contains(github.event.pull_request.labels.*.name, 'needs-deep-review')
      )
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Deep Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            # Stage 1: Deep Review

            This PR was flagged for deep review. Perform comprehensive analysis.

            ---

            ## 1. Architecture & Migration Consistency

            - [ ] No deprecated patterns reintroduced
            - [ ] No duplicate hook patterns (old useQuery vs React Query)
            - [ ] No legacy endpoint usage (/districts instead of /filter-options)
            - [ ] Migration is complete (no mixed old/new patterns)

            **Findings:**

            ---

            ## 2. Stale/Race Safety Checklist

            For each async operation in changed files:

            | File | Hook/Function | Abort Signal? | Stale Guard? | Cleanup? |
            |------|---------------|---------------|--------------|----------|
            | | | | | |

            - [ ] All API calls use abort signal
            - [ ] No setState after unmount possible
            - [ ] React Query OR useStaleRequestGuard used
            - [ ] useEffect cleanup functions present

            **Findings:**

            ---

            ## 3. Contract Semantics

            Beyond schema drift, check semantic correctness:

            - [ ] Response field meanings unchanged (not just names)
            - [ ] Null handling consistent (backend sends null vs undefined)
            - [ ] Array vs single value semantics preserved
            - [ ] Date format expectations match (ISO string vs Date object)
            - [ ] Enum values match between frontend/backend

            **Findings:**

            ---

            ## 4. Provider & Context Tree

            - [ ] All hooks used within required Providers
            - [ ] No orphaned Context consumers
            - [ ] Provider hierarchy correct (Auth > Subscription > Filters)

            **Findings:**

            ---

            ## 5. SQL & Data Safety

            - [ ] Uses `:param` bindings (not f-strings)
            - [ ] Includes `COALESCE(is_outlier, false) = false`
            - [ ] Date bounds exclusive upper bound
            - [ ] NULL guards for optional params
            - [ ] No N+1 query patterns

            **Findings:**

            ---

            ## 6. Breaking Change Analysis

            ```
            Changed Files:
            [list files]

            Downstream Dependents:
            [list files that import/use changed code]

            Breaking Risk:
            [assessment]
            ```

            ---

            ## Go/No-Go Recommendation

            **üö¶ VERDICT:** GO / NO-GO / CONDITIONAL

            If NO-GO or CONDITIONAL, list required fixes:
            1.
            2.
            3.

  # =============================================================================
  # STAGE 1b: Deep Review (triggered by @claude deep-review comment)
  # =============================================================================
  deep-review-on-demand:
    name: "Stage 1: Deep Review (on-demand)"
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude deep-review')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude deep-review'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Deep Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            # Stage 1: Deep Review (Requested)

            User requested deep review. Perform comprehensive analysis.

            ## 1. Architecture & Migration Consistency
            - No deprecated patterns, no duplicate hooks, no legacy endpoints
            - Check migration completeness

            ## 2. Stale/Race Safety
            - Abort signals, stale guards, cleanup functions
            - No setState after unmount

            ## 3. Contract Semantics
            - Response field meanings, null handling, enum values

            ## 4. Provider & Context Tree
            - Hooks within Providers, no orphaned consumers

            ## 5. SQL & Data Safety
            - :param bindings, outlier exclusion, NULL guards

            ## 6. Breaking Changes
            - Trace downstream dependents

            ---

            **üö¶ VERDICT:** GO / NO-GO / CONDITIONAL

            List any required fixes.

  # =============================================================================
  # STAGE 2: CI Summary (after Regression Suite completes)
  # Goal: Human-readable summary of CI results
  # =============================================================================
  ci-summary:
    name: "Stage 2: CI Summary"
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion != 'skipped'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });
            const prs = run.data.pull_requests;
            if (prs && prs.length > 0) {
              return prs[0].number;
            }
            return null;

      - name: Get CI job results
        id: ci-results
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            const summary = jobs.data.jobs.map(job => ({
              name: job.name,
              status: job.conclusion || job.status,
              duration: job.completed_at && job.started_at
                ? Math.round((new Date(job.completed_at) - new Date(job.started_at)) / 1000)
                : null
            }));

            return JSON.stringify(summary);

      - name: Get failure details
        id: failure-logs
        if: github.event.workflow_run.conclusion == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            // Get failed jobs with their failed steps
            const failedJobs = jobs.data.jobs
              .filter(j => j.conclusion === 'failure')
              .slice(0, 3)  // Limit to 3 jobs to avoid token overflow
              .map(job => ({
                name: job.name,
                failed_steps: job.steps
                  .filter(s => s.conclusion === 'failure')
                  .map(s => s.name)
              }));

            return JSON.stringify(failedJobs, null, 2);

      - name: Claude CI Summary
        if: steps.pr.outputs.result != 'null'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            # Stage 2: CI Summary

            The Regression Suite just completed. Summarize results for the team.

            ## CI Job Results

            ```json
            ${{ steps.ci-results.outputs.result }}
            ```

            Overall workflow conclusion: **${{ github.event.workflow_run.conclusion }}**

            ## Failed Jobs Detail (if any)

            ```json
            ${{ steps.failure-logs.outputs.result }}
            ```

            Use the failed steps to diagnose root causes. Common patterns:
            - `contract-guard` + "drift detected" ‚Üí Run `python backend/scripts/generate_contracts.py`
            - `frontend-tests` + "lint" ‚Üí Run `npm run lint:ci` locally
            - `frontend-e2e` + timeout ‚Üí Check for missing mocks or slow renders
            - `integration-tests` + "snapshot" ‚Üí Intentional data change? Run `--update-snapshots`

            ---

            ## Your Task

            ### 1. Jobs Summary

            | Job | Status | Duration | Purpose |
            |-----|--------|----------|---------|
            | (parse from JSON above) | | | (explain what each job checks) |

            Map each job to what it validates:
            - `contract-guard` ‚Üí Frontend/backend contracts in sync
            - `frontend-import-guard` ‚Üí No broken imports or deprecated endpoints
            - `sql-safety` ‚Üí SQL injection protection, proper bindings
            - `data-guard` ‚Üí CSV data integrity
            - `route-contract` ‚Üí All frontend routes exist in backend
            - `smoke-tests` ‚Üí API endpoints respond
            - `unit-tests` ‚Üí Backend logic correct
            - `integration-tests` ‚Üí Regression snapshots, API invariants
            - `frontend-tests` ‚Üí Lint, typecheck, unit tests, build
            - `frontend-e2e` ‚Üí Runtime smoke tests
            - `security-audit` ‚Üí Dependency vulnerabilities

            ### 2. Failures Analysis

            If any jobs failed:

            | Failed Job | Likely Root Cause | Suggested Fix |
            |------------|-------------------|---------------|
            | | | |

            ### 3. Fix Order

            If multiple failures, suggest order to fix (avoid whack-a-mole):

            1. Fix X first because...
            2. Then fix Y because...
            3. Finally fix Z...

            ### 4. Overall Verdict

            **CI Result:** ‚úÖ ALL PASSED / ‚ö†Ô∏è WARNINGS / ‚ùå FAILED

            **Ready to Merge:** YES / NO / AFTER FIXES

  # =============================================================================
  # Q&A: Respond to general @claude questions
  # =============================================================================
  claude-qa:
    name: "Claude Q&A"
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude') && !contains(github.event.comment.body, '@claude deep-review')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude') && !contains(github.event.comment.body, '@claude deep-review')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action == 'opened' && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action == 'assigned' && github.event.assignee.login == 'claude[bot]')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Claude Q&A
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # Answers the user's specific question using CLAUDE.md context
