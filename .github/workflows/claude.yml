name: Claude Code

on:
  # CI Summary: triggers after Regression Suite fails
  workflow_run:
    workflows: ["Regression Suite"]
    types: [completed]
  # Claude Assistant: triggers on @claude mentions
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  # =============================================================================
  # CI Summary - Only runs on failures, explains what broke and how to fix
  # =============================================================================
  ci-summary:
    name: "CI Summary"
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      actions: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });
            const prs = run.data.pull_requests;
            return prs && prs.length > 0 ? prs[0].number : null;

      - name: Get CI job results
        id: ci-results
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            const summary = jobs.data.jobs.map(job => ({
              name: job.name,
              status: job.conclusion || job.status,
              duration: job.completed_at && job.started_at
                ? Math.round((new Date(job.completed_at) - new Date(job.started_at)) / 1000)
                : null
            }));

            return JSON.stringify(summary);

      - name: Get failure details
        id: failure-logs
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            const failedJobs = jobs.data.jobs
              .filter(j => j.conclusion === 'failure')
              .slice(0, 5)
              .map(job => ({
                name: job.name,
                failed_steps: job.steps
                  .filter(s => s.conclusion === 'failure')
                  .map(s => s.name)
              }));

            return JSON.stringify(failedJobs, null, 2);

      - name: Claude CI Summary
        if: steps.pr.outputs.result != 'null'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: "--model claude-3-5-haiku-20241022"
          direct_prompt: true
          prompt: |
            # CI Failed - Diagnose and Fix

            ## Job Results
            ```json
            ${{ steps.ci-results.outputs.result }}
            ```

            ## Failed Jobs
            ```json
            ${{ steps.failure-logs.outputs.result }}
            ```

            ---

            ## Your Response Format

            ### What Failed
            [List each failed job and its failed step]

            ### Root Cause
            [Based on the job name and step, identify the likely cause]

            Common patterns:
            | Job | Likely Cause | Fix |
            |-----|--------------|-----|
            | contract-guard | Schema drift | `python backend/scripts/generate_contracts.py` |
            | frontend-tests (lint) | ESLint errors | `npm run lint:ci` |
            | frontend-tests (typecheck) | TypeScript errors | `npm run typecheck` |
            | integration-tests | Snapshot drift | `pytest --update-snapshots` |
            | sql-safety | SQL injection risk | Use `:param` bindings |
            | frontend-e2e | Runtime error | Check browser console |

            ### Suggested Fix
            [Specific command(s) to run locally]

            ### Fix Order (if multiple failures)
            1. Fix X first because Y depends on it
            2. Then fix Z

  # =============================================================================
  # Claude Assistant - Handles @claude mentions on issues and PRs
  # On issues: Implements features and creates PRs
  # On PRs: Answers questions or makes requested changes
  # =============================================================================
  claude-assistant:
    name: "Claude Assistant"
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine context
        id: context
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            # Check if this is a PR (issues API also returns PRs)
            if [ -n "${{ github.event.issue.pull_request }}" ]; then
              echo "type=pr" >> $GITHUB_OUTPUT
              echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            else
              echo "type=issue" >> $GITHUB_OUTPUT
              echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            fi
          else
            echo "type=pr" >> $GITHUB_OUTPUT
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Get issue details (for Issue -> PR)
        id: issue-info
        if: steps.context.outputs.type == 'issue'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_NUM="${{ steps.context.outputs.number }}"

          # Get issue details
          TITLE=$(gh issue view "$ISSUE_NUM" --json title --jq '.title')
          BODY=$(gh issue view "$ISSUE_NUM" --json body --jq '.body // "No description"')
          LABELS=$(gh issue view "$ISSUE_NUM" --json labels --jq '[.labels[].name] | join(", ")')

          echo "title=$TITLE" >> $GITHUB_OUTPUT

          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "labels=$LABELS" >> $GITHUB_OUTPUT

      - name: Get PR diff (for PR Q&A)
        id: pr-info
        if: steps.context.outputs.type == 'pr'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUM="${{ steps.context.outputs.number }}"

          # Get changed files
          gh pr view "$PR_NUM" --json files --jq '.files[].path' > /tmp/files.txt

          # Get diff (limit 50KB for Q&A)
          gh pr diff "$PR_NUM" | head -c 50000 > /tmp/diff.txt

          echo "files<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/files.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "diff<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/diff.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Claude on Issue (Implement Feature)
        if: steps.context.outputs.type == 'issue'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: "--model claude-sonnet-4-20250514"
          prompt: |
            # Implement Feature from Issue

            ## Issue #${{ steps.context.outputs.number }}: ${{ steps.issue-info.outputs.title }}

            ### Description
            ${{ steps.issue-info.outputs.body }}

            ### Labels
            ${{ steps.issue-info.outputs.labels }}

            ## User Request
            ${{ github.event.comment.body }}

            ---

            ## Instructions

            1. Read CLAUDE.md for codebase standards
            2. Find reference implementations for similar features
            3. Implement the requested feature following existing patterns
            4. Create a PR with the implementation

            **Important:**
            - Follow layer responsibilities (Pages decide -> Components render)
            - Use existing constants (SaleType, REGIONS, etc.)
            - Match existing code patterns exactly
            - Include appropriate error handling
            - Run linting before committing

      - name: Claude on PR (Answer/Assist)
        if: steps.context.outputs.type == 'pr'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: "--model claude-3-5-haiku-20241022"
          prompt: |
            # PR Assistant

            PR #${{ steps.context.outputs.number }}

            ## Files Changed
            ```
            ${{ steps.pr-info.outputs.files }}
            ```

            ## Diff (first 50KB)
            ```diff
            ${{ steps.pr-info.outputs.diff }}
            ```

            ## User Question
            ${{ github.event.comment.body }}

            ---

            Answer the user's question directly and concisely.

            If they're asking for a change, make it.
            If they're asking a question, answer it.

            Keep responses focused - no lengthy reviews unless explicitly requested.
