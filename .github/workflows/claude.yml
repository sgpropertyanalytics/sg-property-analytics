name: Claude Code

on:
  # CI Summary: triggers after Regression Suite completes
  workflow_run:
    workflows: ["Regression Suite"]
    types: [completed]
  # Q&A: triggers on @claude mentions
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened]

jobs:
  # =============================================================================
  # CI Summary (after Regression Suite completes)
  # Goal: Human-readable summary of CI results
  # =============================================================================
  ci-summary:
    name: "CI Summary"
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion != 'skipped'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      actions: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });
            const prs = run.data.pull_requests;
            if (prs && prs.length > 0) {
              return prs[0].number;
            }
            return null;

      - name: Get CI job results
        id: ci-results
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            const summary = jobs.data.jobs.map(job => ({
              name: job.name,
              status: job.conclusion || job.status,
              duration: job.completed_at && job.started_at
                ? Math.round((new Date(job.completed_at) - new Date(job.started_at)) / 1000)
                : null
            }));

            return JSON.stringify(summary);

      - name: Get failure details
        id: failure-logs
        if: github.event.workflow_run.conclusion == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            // Get failed jobs with their failed steps
            const failedJobs = jobs.data.jobs
              .filter(j => j.conclusion === 'failure')
              .slice(0, 3)  // Limit to 3 jobs to avoid token overflow
              .map(job => ({
                name: job.name,
                failed_steps: job.steps
                  .filter(s => s.conclusion === 'failure')
                  .map(s => s.name)
              }));

            return JSON.stringify(failedJobs, null, 2);

      - name: Claude CI Summary
        if: steps.pr.outputs.result != 'null'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: "--model claude-3-5-haiku-20241022"
          direct_prompt: true
          prompt: |
            # CI Summary

            The Regression Suite just completed. Summarize results for the team.

            ## CI Job Results

            ```json
            ${{ steps.ci-results.outputs.result }}
            ```

            Overall workflow conclusion: **${{ github.event.workflow_run.conclusion }}**

            ## Failed Jobs Detail (if any)

            ```json
            ${{ steps.failure-logs.outputs.result }}
            ```

            Use the failed steps to diagnose root causes. Common patterns:
            - `contract-guard` + "drift detected" ‚Üí Run `python backend/scripts/generate_contracts.py`
            - `frontend-tests` + "lint" ‚Üí Run `npm run lint:ci` locally
            - `frontend-e2e` + timeout ‚Üí Check for missing mocks or slow renders
            - `integration-tests` + "snapshot" ‚Üí Intentional data change? Run `--update-snapshots`

            ---

            ## Your Task

            ### 1. Jobs Summary

            | Job | Status | Duration | Purpose |
            |-----|--------|----------|---------|
            | (parse from JSON above) | | | (explain what each job checks) |

            Map each job to what it validates:
            - `contract-guard` ‚Üí Frontend/backend contracts in sync
            - `frontend-import-guard` ‚Üí No broken imports or deprecated endpoints
            - `sql-safety` ‚Üí SQL injection protection, proper bindings
            - `data-guard` ‚Üí CSV data integrity
            - `route-contract` ‚Üí All frontend routes exist in backend
            - `smoke-tests` ‚Üí API endpoints respond
            - `unit-tests` ‚Üí Backend logic correct
            - `integration-tests` ‚Üí Regression snapshots, API invariants
            - `frontend-tests` ‚Üí Lint, typecheck, unit tests, build
            - `frontend-e2e` ‚Üí Runtime smoke tests
            - `security-audit` ‚Üí Dependency vulnerabilities

            ### 2. Failures Analysis

            If any jobs failed:

            | Failed Job | Likely Root Cause | Suggested Fix |
            |------------|-------------------|---------------|
            | | | |

            ### 3. Fix Order

            If multiple failures, suggest order to fix (avoid whack-a-mole):

            1. Fix X first because...
            2. Then fix Y because...
            3. Finally fix Z...

            ### 4. Overall Verdict

            **CI Result:** ‚úÖ ALL PASSED / ‚ö†Ô∏è WARNINGS / ‚ùå FAILED

            **Ready to Merge:** YES / NO / AFTER FIXES

  # =============================================================================
  # Architecture Review: @claude review triggers 6-point quality checklist
  # =============================================================================
  architecture-review:
    name: "Architecture Review"
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude') && contains(github.event.comment.body, 'review')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude') && contains(github.event.comment.body, 'review'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      actions: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for pattern comparison

      - name: Claude Architecture Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: "--model claude-3-5-haiku-20241022"
          prompt: |
            # Architecture Review Checklist

            Review this PR against the codebase standards in CLAUDE.md and .claude/review-rules.yml.
            Evaluate each criterion and provide a clear verdict.

            ## 6-Point Quality Checklist

            ### 1. Framework Alignment
            **Question:** Is this aligned and consistent with the latest code design framework patterns, standards, and architectural patterns?

            Check against:
            - Layer responsibilities (Pages decide ‚Üí Components render ‚Üí Utils transform ‚Üí Backend enforces)
            - Single source of truth (SaleType enum, constants.py, contract_schema.py)
            - Reference implementations in TimeTrendChart.jsx, analytics.py, dashboard_service.py

            **Verdict:** ‚úÖ ALIGNED / ‚ö†Ô∏è PARTIAL / ‚ùå VIOLATES

            ### 2. Code Efficiency
            **Question:** Is this clean, efficient code design?

            Check for:
            - Minimal code to achieve the goal
            - No unnecessary abstractions
            - Clear data flow
            - Appropriate use of existing utilities

            **Verdict:** ‚úÖ CLEAN / ‚ö†Ô∏è COULD SIMPLIFY / ‚ùå NEEDS REFACTOR

            ### 3. Over-Engineering Detection
            **Question:** Are there over-engineering characteristics with redundant complexity layers?

            Red flags:
            - New abstractions for single-use cases
            - Premature optimization
            - Feature flags for simple changes
            - Custom infrastructure when libraries exist (React Query, Zustand)
            - >50 lines of custom hooks

            **Verdict:** ‚úÖ APPROPRIATE / ‚ö†Ô∏è BORDERLINE / ‚ùå OVER-ENGINEERED

            ### 4. Band-Aid Detection
            **Question:** Is this a band-aid fix?

            Red flags:
            - `if (specificEdgeCase)` hacks
            - Hardcoded values instead of constants
            - `// TODO: fix later` comments
            - Duplicating code "to be safe"
            - Workarounds instead of root cause fixes

            **Verdict:** ‚úÖ ROOT CAUSE FIX / ‚ö†Ô∏è ACCEPTABLE WORKAROUND / ‚ùå BAND-AID

            ### 5. Production-Grade Assessment
            **Question:** Is this a production-grade, long-term scalable solution that is robust and regression-proof?

            Check for:
            - Works at 10x scale
            - Handles edge cases gracefully
            - Has appropriate error handling
            - Includes necessary tests
            - Matches how similar problems are solved in codebase

            **Verdict:** ‚úÖ PRODUCTION-GRADE / ‚ö†Ô∏è NEEDS HARDENING / ‚ùå NOT READY

            ### 6. Canonical Standards
            **Question:** Does this follow canonical clean standardized framework with centralized API/Constants/related functions?

            Check for:
            - Uses existing constants (REGIONS, BEDROOM_ORDER, SaleType)
            - Uses centralized API client (api/client.js)
            - Uses existing adapters pattern
            - SQL in services, not routes
            - :param bindings, not f-strings

            **Verdict:** ‚úÖ CANONICAL / ‚ö†Ô∏è MINOR DEVIATIONS / ‚ùå NON-STANDARD

            ---

            ## Quick Compliance Checks

            Verify these specific requirements (auto-fail if violated):

            | Check | Status | Details |
            |-------|--------|---------|
            | **Layer responsibilities** | ‚úÖ/‚ùå | Pages decide logic, Components only render props |
            | **No new abstractions** | ‚úÖ/‚ùå | Uses existing patterns, no reinventing |
            | **SQL param bindings** | ‚úÖ/‚ùå | Uses `:param` style, never f-strings |
            | **Outlier exclusion** | ‚úÖ/‚ùå | All transaction queries include `COALESCE(is_outlier, false) = false` |
            | **Chart state handling** | ‚úÖ/‚ùå | Charts handle loading/error/empty/success states |

            ---

            ## Summary

            | Criterion | Verdict | Notes |
            |-----------|---------|-------|
            | 1. Framework Alignment | | |
            | 2. Code Efficiency | | |
            | 3. Over-Engineering | | |
            | 4. Band-Aid Detection | | |
            | 5. Production-Grade | | |
            | 6. Canonical Standards | | |

            ## Overall Assessment

            **Score:** X/6 passing

            **Recommendation:** ‚úÖ APPROVE / ‚ö†Ô∏è APPROVE WITH COMMENTS / üîÑ REQUEST CHANGES / ‚ùå BLOCK

            ## Specific Issues (if any)

            List specific files and line numbers that need attention.

            ## Suggested Improvements (if any)

            Concrete suggestions to improve the PR.

  # =============================================================================
  # Q&A: Respond to @claude questions in PRs/Issues
  # =============================================================================
  claude-qa:
    name: "Claude Q&A"
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action == 'opened' && contains(github.event.issue.body, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      actions: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Claude Q&A
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: "--model claude-3-5-haiku-20241022"
          # Answers the user's specific question using CLAUDE.md context
