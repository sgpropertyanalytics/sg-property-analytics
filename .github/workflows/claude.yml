name: Claude Code

on:
  # CI Summary: triggers after Regression Suite completes
  workflow_run:
    workflows: ["Regression Suite"]
    types: [completed]
  # Q&A: triggers on @claude mentions
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened]

jobs:
  # =============================================================================
  # CI Summary (after Regression Suite completes)
  # Goal: Human-readable summary of CI results
  # =============================================================================
  ci-summary:
    name: "CI Summary"
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion != 'skipped'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });
            const prs = run.data.pull_requests;
            if (prs && prs.length > 0) {
              return prs[0].number;
            }
            return null;

      - name: Get CI job results
        id: ci-results
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            const summary = jobs.data.jobs.map(job => ({
              name: job.name,
              status: job.conclusion || job.status,
              duration: job.completed_at && job.started_at
                ? Math.round((new Date(job.completed_at) - new Date(job.started_at)) / 1000)
                : null
            }));

            return JSON.stringify(summary);

      - name: Get failure details
        id: failure-logs
        if: github.event.workflow_run.conclusion == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            // Get failed jobs with their failed steps
            const failedJobs = jobs.data.jobs
              .filter(j => j.conclusion === 'failure')
              .slice(0, 3)  // Limit to 3 jobs to avoid token overflow
              .map(job => ({
                name: job.name,
                failed_steps: job.steps
                  .filter(s => s.conclusion === 'failure')
                  .map(s => s.name)
              }));

            return JSON.stringify(failedJobs, null, 2);

      - name: Claude CI Summary
        if: steps.pr.outputs.result != 'null'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: "--model claude-3-5-haiku-20241022"
          direct_prompt: true
          prompt: |
            # CI Summary

            The Regression Suite just completed. Summarize results for the team.

            ## CI Job Results

            ```json
            ${{ steps.ci-results.outputs.result }}
            ```

            Overall workflow conclusion: **${{ github.event.workflow_run.conclusion }}**

            ## Failed Jobs Detail (if any)

            ```json
            ${{ steps.failure-logs.outputs.result }}
            ```

            Use the failed steps to diagnose root causes. Common patterns:
            - `contract-guard` + "drift detected" → Run `python backend/scripts/generate_contracts.py`
            - `frontend-tests` + "lint" → Run `npm run lint:ci` locally
            - `frontend-e2e` + timeout → Check for missing mocks or slow renders
            - `integration-tests` + "snapshot" → Intentional data change? Run `--update-snapshots`

            ---

            ## Your Task

            ### 1. Jobs Summary

            | Job | Status | Duration | Purpose |
            |-----|--------|----------|---------|
            | (parse from JSON above) | | | (explain what each job checks) |

            Map each job to what it validates:
            - `contract-guard` → Frontend/backend contracts in sync
            - `frontend-import-guard` → No broken imports or deprecated endpoints
            - `sql-safety` → SQL injection protection, proper bindings
            - `data-guard` → CSV data integrity
            - `route-contract` → All frontend routes exist in backend
            - `smoke-tests` → API endpoints respond
            - `unit-tests` → Backend logic correct
            - `integration-tests` → Regression snapshots, API invariants
            - `frontend-tests` → Lint, typecheck, unit tests, build
            - `frontend-e2e` → Runtime smoke tests
            - `security-audit` → Dependency vulnerabilities

            ### 2. Failures Analysis

            If any jobs failed:

            | Failed Job | Likely Root Cause | Suggested Fix |
            |------------|-------------------|---------------|
            | | | |

            ### 3. Fix Order

            If multiple failures, suggest order to fix (avoid whack-a-mole):

            1. Fix X first because...
            2. Then fix Y because...
            3. Finally fix Z...

            ### 4. Overall Verdict

            **CI Result:** ✅ ALL PASSED / ⚠️ WARNINGS / ❌ FAILED

            **Ready to Merge:** YES / NO / AFTER FIXES

  # =============================================================================
  # Q&A: Respond to @claude questions in PRs/Issues
  # =============================================================================
  claude-qa:
    name: "Claude Q&A"
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action == 'opened' && contains(github.event.issue.body, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Claude Q&A
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: "--model claude-3-5-haiku-20241022"
          # Answers the user's specific question using CLAUDE.md context
